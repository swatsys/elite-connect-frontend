<!-- 
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Elite Connect - Dating App</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .card {
      background: white;
      padding: 2rem;
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 500px;
      width: 100%;
      animation: slideUp 0.5s ease-out;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .screen {
      min-height: 100vh;
      padding-bottom: 80px;
    }

    .screen-content {
      max-width: 500px;
      margin: 0 auto;
      padding: 1rem;
    }

    .logo {
      font-size: 4rem;
      text-align: center;
      margin-bottom: 1rem;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    h1 {
      font-size: 2rem;
      text-align: center;
      background: linear-gradient(135deg, #ec4899, #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;  /* ‚Üê Added for compatibility */
      color: transparent;  
      margin-bottom: 1rem;
    }

    h2 {
      font-size: 1.5rem;
      color: #333;
      margin-bottom: 1rem;
    }

    p {
      color: #666;
      line-height: 1.6;
      margin-bottom: 1rem;
    }

    button {
      background: linear-gradient(135deg, #ec4899, #8b5cf6);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
      margin-top: 0.5rem;
      transition: all 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
    }

    .btn-success {
      background: linear-gradient(135deg, #10b981, #059669);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444, #dc2626);
    }

    .btn-small {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      width: auto;
    }

    input, textarea, select {
      width: 100%;
      padding: 0.875rem;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-size: 1rem;
      margin-top: 0.5rem;
      font-family: inherit;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #8b5cf6;
    }

    label {
      display: block;
      font-weight: 600;
      color: #333;
      margin-top: 1rem;
    }

    .hidden {
      display: none !important;
    }

    /* Navigation */
    .nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      display: flex;
      justify-content: space-around;
      padding: 0.75rem;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
      z-index: 1000;
    }

    .nav-btn {
      background: none;
      border: none;
      color: #666;
      font-size: 0.75rem;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0.5rem;
      width: auto;
      margin: 0;
      transition: color 0.2s;
    }

    .nav-btn:hover {
      transform: none;
      box-shadow: none;
    }

    .nav-btn.active {
      color: #8b5cf6;
    }

    .nav-btn span {
      font-size: 1.5rem;
      margin-bottom: 0.25rem;
    }

    /* Swipe Card */
    .swipe-container {
      position: relative;
      height: 70vh;
      max-width: 400px;
      margin: 0 auto;
    }

    .swipe-card {
      position: absolute;
      width: 100%;
      height: 100%;
      background: white;
      border-radius: 24px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      padding: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      transition: transform 0.3s, opacity 0.3s;
    }

    .swipe-card.swiping {
      transition: none;
    }

    .swipe-photo {
      width: 200px;
      height: 200px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 6rem;
      margin-bottom: 1rem;
    }

    .swipe-actions {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
    }

    .swipe-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .swipe-btn:hover {
      transform: scale(1.1);
    }

    /* Match Modal */
    .match-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .match-content {
      text-align: center;
      color: white;
    }

    .match-content .logo {
      font-size: 6rem;
      animation: bounce 0.5s;
    }

    @keyframes bounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }

    /* Lists */
    .list-item {
      background: white;
      padding: 1rem;
      border-radius: 12px;
      margin-bottom: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .list-item:hover {
      transform: translateX(4px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .list-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      flex-shrink: 0;
    }

    .list-info {
      flex: 1;
    }

    .list-name {
      font-weight: bold;
      font-size: 1.1rem;
      color: #333;
    }

    .list-detail {
      font-size: 0.875rem;
      color: #666;
      margin-top: 0.25rem;
    }

    .badge {
      background: #8b5cf6;
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: bold;
    }

    /* Chat */
    .chat-messages {
      height: 60vh;
      overflow-y: auto;
      margin-bottom: 1rem;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 12px;
    }

    .message {
      background: white;
      padding: 0.75rem 1rem;
      border-radius: 12px;
      margin-bottom: 0.5rem;
      max-width: 80%;
    }

    .message.own {
      background: #8b5cf6;
      color: white;
      margin-left: auto;
      text-align: right;
    }

    .message.other {
      background: #e9ecef;
    }

    .message-time {
      font-size: 0.75rem;
      opacity: 0.7;
      margin-top: 0.25rem;
    }

    .message-input-container {
      display: flex;
      gap: 0.5rem;
      background: white;
      padding: 1rem;
      border-radius: 12px;
    }

    .message-input-container input {
      margin-top: 0;
      flex: 1;
    }

    .message-input-container button {
      margin-top: 0;
      width: auto;
      padding: 0.875rem 1.5rem;
    }

    /* Premium Plans */
    .plan-card {
      background: white;
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      border: 2px solid #e0e0e0;
      transition: all 0.2s;
    }

    .plan-card:hover {
      border-color: #8b5cf6;
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
    }

    .plan-card.featured {
      border-color: #8b5cf6;
      position: relative;
    }

    .plan-badge {
      position: absolute;
      top: -12px;
      right: 20px;
      background: linear-gradient(135deg, #ec4899, #8b5cf6);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: bold;
    }

    .plan-price {
      font-size: 2rem;
      font-weight: bold;
      color: #333;
      margin: 0.5rem 0;
    }

    .plan-features {
      list-style: none;
      margin: 1rem 0;
    }

    .plan-features li {
      padding: 0.5rem 0;
      color: #666;
    }

    .plan-features li:before {
      content: "‚úì ";
      color: #10b981;
      font-weight: bold;
      margin-right: 0.5rem;
    }

    /* Utilities */
    .text-center {
      text-align: center;
    }

    .mt-1 { margin-top: 0.5rem; }
    .mt-2 { margin-top: 1rem; }
    .mt-3 { margin-top: 1.5rem; }
    .mb-1 { margin-bottom: 0.5rem; }
    .mb-2 { margin-bottom: 1rem; }

    .loading {
      text-align: center;
      padding: 2rem;
      color: #666;
    }

    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #999;
    }

    .empty-state .logo {
      font-size: 3rem;
      opacity: 0.3;
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    import { MiniKit, VerificationLevel } from 'https://cdn.jsdelivr.net/npm/@worldcoin/minikit-js@1.9.6/+esm'

    // ============================================
    // CONFIGURATION
    // ============================================
    const APP_ID = 'app_486e187afe7bc69a19456a3fa901a162' // CHANGE THIS!
    const API_URL = 'https://elite-connect-backend-ktv9.onrender.com/api' // CHANGE FOR PRODUCTION!

    console.log('üîß Installing MiniKit...')
    MiniKit.install(APP_ID)
    console.log('‚úÖ MiniKit installed')

    // ============================================
    // STATE MANAGEMENT
    // ============================================
    let state = {
      screen: 'loading',
      user: null,
      profile: null,
      token: localStorage.getItem('token'),
      
      // Explore
      exploreUsers: [],
      currentUserIndex: 0,
      
      // Matches
      matches: [],
      
      // Chat
      currentMatch: null,
      messages: [],
      conversations: [],
      
      // Subscription
      subscription: null,
      plans: []
    }

    // ============================================
    // API FUNCTIONS
    // ============================================
    async function api(endpoint, options = {}) {
      const headers = { 'Content-Type': 'application/json' }
      if (state.token) {
        headers['Authorization'] = `Bearer ${state.token}`
      }
      
      const response = await fetch(`${API_URL}${endpoint}`, {
        ...options,
        headers: { ...headers, ...options.headers }
      })
      
      return response.json()
    }

    // ============================================
    // AUTH FUNCTIONS
    // ============================================
    async function handleSignIn() {
      try {
        console.log('üîê Signing in...')
        
        const { finalPayload } = await MiniKit.commandsAsync.verify({
          action: 'login',
          signal: '',
          verification_level: VerificationLevel.Device
        })

        if (finalPayload.status === 'success') {
          const data = await api('/api/auth/verify', {
            method: 'POST',
            body: JSON.stringify({ payload: finalPayload, action: 'login' })
          })

          if (data.success) {
            state.user = data.user
            state.token = data.token
            localStorage.setItem('token', data.token)
            
            // Check if profile exists
            await loadProfile()
          } else {
            alert('Sign in failed: ' + data.error)
          }
        }
      } catch (error) {
        console.error('Error:', error)
        alert('Error: ' + error.message)
      }
    }

    async function handleLogout() {
      localStorage.removeItem('token')
      state = { ...state, screen: 'signin', user: null, profile: null, token: null }
      render()
    }

    // ============================================
    // PROFILE FUNCTIONS
    // ============================================
    async function loadProfile() {
      try {
        const data = await api('/api/profile/me')
        if (data.profile) {
          state.profile = data.profile
          state.screen = 'explore'
          await loadExploreUsers()
        } else {
          state.screen = 'profileSetup'
        }
        render()
      } catch (error) {
        state.screen = 'profileSetup'
        render()
      }
    }

    async function handleProfileSubmit(event) {
      event.preventDefault()
      try {
        const formData = {
          name: document.getElementById('name').value,
          age: document.getElementById('age').value,
          gender: document.getElementById('gender').value,
          bio: document.getElementById('bio').value,
          interests: document.getElementById('interests')?.value.split(',').map(i => i.trim()).filter(Boolean) || []
        }

        const data = await api('/api/profile/create', {
          method: 'POST',
          body: JSON.stringify(formData)
        })

        if (data.success) {
          state.profile = data.profile
          state.screen = 'explore'
          await loadExploreUsers()
          render()
        } else {
          alert('Failed: ' + data.error)
        }
      } catch (error) {
        alert('Error: ' + error.message)
      }
    }

    // ============================================
    // EXPLORE FUNCTIONS
    // ============================================
    async function loadExploreUsers() {
      try {
        const data = await api('/api/explore/users', { method: 'POST' })
        if (data.success) {
          state.exploreUsers = data.users
          state.currentUserIndex = 0
        }
      } catch (error) {
        console.error('Error loading users:', error)
      }
    }

    async function handleSwipe(action) {
      if (state.currentUserIndex >= state.exploreUsers.length) {
        await loadExploreUsers()
        render()
        return
      }

      const currentUser = state.exploreUsers[state.currentUserIndex]
      
      try {
        const data = await api('/api/explore/swipe', {
          method: 'POST',
          body: JSON.stringify({
            target_user_id: currentUser.id,
            action
          })
        })

        if (data.success) {
          if (data.is_match) {
            // Show match modal
            showMatchModal(currentUser)
          }
          
          state.currentUserIndex++
          render()
        }
      } catch (error) {
        console.error('Error swiping:', error)
      }
    }

    function showMatchModal(user) {
      const modal = document.createElement('div')
      modal.className = 'match-modal'
      modal.innerHTML = `
        <div class="match-content">
          <div class="logo">üéâ</div>
          <h1 style="color: white; font-size: 3rem;">It's a Match!</h1>
          <p style="color: white; font-size: 1.2rem; margin: 1rem 0;">
            You and ${user.name} liked each other!
          </p>
          <button onclick="closeMatchModal()">Send Message</button>
          <button class="btn-secondary" onclick="closeMatchModal(); changeScreen('explore')">Keep Swiping</button>
        </div>
      `
      document.body.appendChild(modal)
      
      window.closeMatchModal = () => {
        modal.remove()
        changeScreen('matches')
      }
    }

    // ============================================
    // MATCHES FUNCTIONS
    // ============================================
    async function loadMatches() {
      try {
        const data = await api('/api/explore/matches')
        if (data.success) {
          state.matches = data.matches
          render()
        }
      } catch (error) {
        console.error('Error loading matches:', error)
      }
    }

    // ============================================
    // CHAT FUNCTIONS
    // ============================================
    async function loadConversations() {
      try {
        const data = await api('/api/chat/conversations')
        if (data.success) {
          state.conversations = data.conversations
          render()
        }
      } catch (error) {
        console.error('Error loading conversations:', error)
      }
    }

    async function openChat(matchId) {
      state.currentMatch = matchId
      await loadMessages(matchId)
      render()
    }

    function closeChat() {
      state.currentMatch = null
      render()
    }

    async function loadMessages(matchId) {
      try {
        const data = await api(`/api/chat/messages/${matchId}`)
        if (data.success) {
          state.messages = data.messages
          render()
          setTimeout(scrollToBottom, 100)
        }
      } catch (error) {
        console.error('Error loading messages:', error)
      }
    }

    async function sendMessage() {
      const input = document.getElementById('messageInput')
      const text = input.value.trim()
      if (!text) return

      try {
        const data = await api('/api/chat/send', {
          method: 'POST',
          body: JSON.stringify({
            match_id: state.currentMatch,
            text
          })
        })

        if (data.success) {
          input.value = ''
          await loadMessages(state.currentMatch)
        }
      } catch (error) {
        console.error('Error sending message:', error)
      }
    }

    function scrollToBottom() {
      const messagesDiv = document.getElementById('messages')
      if (messagesDiv) {
        messagesDiv.scrollTop = messagesDiv.scrollHeight
      }
    }

    // ============================================
    // SUBSCRIPTION FUNCTIONS
    // ============================================
    async function loadSubscriptionInfo() {
      try {
        const [plansData, statusData] = await Promise.all([
          api('/api/subscription/plans'),
          api('/api/subscription/status')
        ])
        
        if (plansData.success) state.plans = plansData.plans
        if (statusData.success) state.subscription = statusData.subscription
        
        render()
      } catch (error) {
        console.error('Error loading subscription:', error)
      }
    }

    async function subscribe(planId) {
      try {
        const data = await api('/api/subscription/subscribe', {
          method: 'POST',
          body: JSON.stringify({ plan: planId })
        })

        if (data.success) {
          alert('‚úÖ Subscription successful!')
          await loadSubscriptionInfo()
        } else {
          alert('Failed: ' + data.error)
        }
      } catch (error) {
        alert('Error: ' + error.message)
      }
    }

    // ============================================
    // NAVIGATION
    // ============================================
    window.changeScreen = function(screen) {
      state.screen = screen
      
      if (screen === 'explore') {
        loadExploreUsers()
      } else if (screen === 'matches') {
        loadMatches()
      } else if (screen === 'chat') {
        state.currentMatch = null
        loadConversations()
      } else if (screen === 'subscription') {
        loadSubscriptionInfo()
      }
      
      render()
    }

    window.openWorldApp = function() {
      const url = window.location.href
      window.location.href = `https://worldcoin.org/mini-apps?url=${encodeURIComponent(url)}`
    }

    window.handleSignIn = handleSignIn
    window.handleLogout = handleLogout
    window.handleProfileSubmit = handleProfileSubmit
    window.handleSwipe = handleSwipe
    window.openChat = openChat
    window.closeChat = closeChat
    window.sendMessage = sendMessage
    window.subscribe = subscribe

    // ============================================
    // RENDER FUNCTIONS
    // ============================================
    function renderLoading() {
      return `
        <div class="container">
          <div class="card">
            <div class="logo">üíï</div>
            <h1>Elite Connect</h1>
            <p class="text-center">Loading...</p>
          </div>
        </div>
      `
    }

    function renderNotWorldApp() {
      return `
        <div class="container">
          <div class="card">
            <div class="logo">üåç</div>
            <h1>Open in World App</h1>
            <p class="text-center">This app only works inside World App</p>
            <button class="btn-success" onclick="openWorldApp()">
              üöÄ Open in World App
            </button>
          </div>
        </div>
      `
    }

    function renderSignIn() {
      return `
        <div class="container">
          <div class="card">
            <div class="logo">üíï</div>
            <h1>Elite Connect</h1>
            <p class="text-center">Verified connections, genuine hearts</p>
            <button onclick="handleSignIn()">
              üåç Sign in with World ID
            </button>
            <div class="text-center mt-3" style="font-size: 0.875rem; color: #666;">
              <p>‚úì Privacy-preserving verification</p>
              <p>‚úì One person, one profile</p>
              <p>‚úì Verified humans only</p>
            </div>
          </div>
        </div>
      `
    }

    function renderProfileSetup() {
      return `
        <div class="container">
          <div class="card">
            <div class="logo">‚ú®</div>
            <h1>Create Your Profile</h1>
            <p class="text-center">Tell us about yourself</p>
            <form onsubmit="handleProfileSubmit(event)">
              <label>Name *</label>
              <input type="text" id="name" required placeholder="Your name">
              
              <label>Age *</label>
              <input type="number" id="age" required min="18" max="100" placeholder="Your age">
              
              <label>Gender *</label>
              <select id="gender" required>
                <option value="">Select gender</option>
                <option value="male">Male</option>
                <option value="female">Female</option>
                <option value="other">Other</option>
              </select>
              
              <label>Bio</label>
              <textarea id="bio" rows="3" placeholder="Tell us about yourself..."></textarea>
              
              <label>Interests (comma-separated)</label>
              <input type="text" id="interests" placeholder="e.g. hiking, music, travel">
              
              <button type="submit" class="mt-2">‚úÖ Create Profile</button>
            </form>
          </div>
        </div>
      `
    }

    function renderExplore() {
      const currentUser = state.exploreUsers[state.currentUserIndex]
      
      if (!currentUser) {
        return `
          <div class="screen">
            <div class="screen-content">
              <div class="empty-state">
                <div class="logo">üîç</div>
                <h2>No More Users</h2>
                <p>Check back later for more profiles!</p>
                <button onclick="changeScreen('explore')" class="mt-2">üîÑ Refresh</button>
              </div>
            </div>
          </div>
          ${renderNav('explore')}
        `
      }

      const emoji = currentUser.gender === 'male' ? 'üë®' : currentUser.gender === 'female' ? 'üë©' : 'üßë'
      
      return `
        <div class="screen">
          <div class="screen-content">
            <h2 class="text-center mb-2">Discover</h2>
            <div class="swipe-container">
              <div class="swipe-card">
                <div class="swipe-photo">${emoji}</div>
                <h2>${currentUser.name}, ${currentUser.age}</h2>
                <p style="color: #999;">${currentUser.bio || 'No bio yet'}</p>
                ${currentUser.interests && currentUser.interests.length > 0 ? `
                  <div style="margin-top: 1rem;">
                    ${currentUser.interests.map(i => `<span class="badge">${i}</span>`).join(' ')}
                  </div>
                ` : ''}
                <div class="swipe-actions">
                  <button class="swipe-btn btn-danger" onclick="handleSwipe('pass')">‚úñÔ∏è</button>
                  <button class="swipe-btn btn-success" onclick="handleSwipe('like')">üíö</button>
                  <button class="swipe-btn btn-secondary" onclick="handleSwipe('super_like')">‚≠ê</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        ${renderNav('explore')}
      `
    }

    function renderMatches() {
      return `
        <div class="screen">
          <div class="screen-content">
            <h2 class="mb-2">Your Matches</h2>
            ${state.matches.length === 0 ? `
              <div class="empty-state">
                <div class="logo">üíî</div>
                <p>No matches yet. Keep swiping!</p>
                <button onclick="changeScreen('explore')" class="mt-2">Start Swiping</button>
              </div>
            ` : `
              ${state.matches.map(match => {
                const emoji = match.user.gender === 'male' ? 'üë®' : match.user.gender === 'female' ? 'üë©' : 'üßë'
                return `
                  <div class="list-item" onclick="openChat('${match.match_id}')">
                    <div class="list-avatar">${emoji}</div>
                    <div class="list-info">
                      <div class="list-name">${match.user.name}, ${match.user.age}</div>
                      <div class="list-detail">Matched ${new Date(match.matched_at).toLocaleDateString()}</div>
                    </div>
                  </div>
                `
              }).join('')}
            `}
          </div>
        </div>
        ${renderNav('matches')}
      `
    }

    function renderChat() {
      if (!state.currentMatch) {
        return `
          <div class="screen">
            <div class="screen-content">
              <h2 class="mb-2">Messages</h2>
              ${state.conversations.length === 0 ? `
                <div class="empty-state">
                  <div class="logo">üí¨</div>
                  <p>No conversations yet</p>
                  <button onclick="changeScreen('matches')" class="mt-2">View Matches</button>
                </div>
              ` : `
                ${state.conversations.map(conv => {
                  const emoji = conv.user?.gender === 'male' ? 'üë®' : conv.user?.gender === 'female' ? 'üë©' : 'üßë'
                  return `
                    <div class="list-item" onclick="openChat('${conv.match_id}')">
                      <div class="list-avatar">${emoji}</div>
                      <div class="list-info">
                        <div class="list-name">${conv.user?.name || 'User'}</div>
                        <div class="list-detail">
                          ${conv.last_message ? (conv.last_message.is_mine ? 'You: ' : '') + conv.last_message.text.substring(0, 40) + '...' : 'Say hi!'}
                        </div>
                      </div>
                      ${conv.unread_count > 0 ? `<span class="badge">${conv.unread_count}</span>` : ''}
                    </div>
                  `
                }).join('')}
              `}
            </div>
          </div>
          ${renderNav('chat')}
        `
      }

      const conversation = state.conversations.find(c => c.match_id === state.currentMatch)
      const userName = conversation?.user?.name || 'User'
      
      return `
        <div class="screen">
          <div class="screen-content">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; background: white; padding: 1rem; border-radius: 12px;">
              <button onclick="closeChat()" class="btn-small">‚Üê Back</button>
              <h2 style="margin: 0;">${userName}</h2>
            </div>
            <div class="chat-messages" id="messages">
              ${state.messages.length === 0 ? `
                <p class="text-center" style="color: #999;">No messages yet. Say hi!</p>
              ` : `
                ${state.messages.map(msg => `
                  <div class="message ${msg.is_mine ? 'own' : 'other'}">
                    <p>${msg.text}</p>
                    <div class="message-time">${new Date(msg.created_at).toLocaleTimeString()}</div>
                  </div>
                `).join('')}
              `}
            </div>
            <div class="message-input-container">
              <input 
                type="text" 
                id="messageInput" 
                placeholder="Type a message..." 
                onkeypress="if(event.key==='Enter') sendMessage()"
              >
              <button onclick="sendMessage()">Send</button>
            </div>
          </div>
        </div>
        ${renderNav('chat')}
      `
    }

    function renderSubscription() {
      return `
        <div class="screen">
          <div class="screen-content">
            <h2 class="mb-2">Premium Plans</h2>
            ${state.subscription ? `
              <div class="plan-card featured">
                <div class="plan-badge">ACTIVE</div>
                <h3>${state.subscription.plan.toUpperCase()}</h3>
                <div class="plan-price">Active</div>
                <p>Expires: ${new Date(state.subscription.expires_at).toLocaleDateString()}</p>
              </div>
            ` : ''}
            ${state.plans.map(plan => `
              <div class="plan-card ${plan.id === 'premium' ? 'featured' : ''}">
                ${plan.id === 'premium' ? '<div class="plan-badge">POPULAR</div>' : ''}
                <h3>${plan.name}</h3>
                <div class="plan-price">$${plan.price}<span style="font-size: 1rem;">/mo</span></div>
                <ul class="plan-features">
                  ${plan.features.unlimited_likes ? '<li>Unlimited Likes</li>' : ''}
                  ${plan.features.super_likes > 0 ? `<li>${plan.features.super_likes} Super Likes</li>` : ''}
                  ${plan.features.rewind ? '<li>Rewind</li>' : ''}
                  ${plan.features.see_who_liked_you ? '<li>See Who Liked You</li>' : ''}
                  ${plan.features.boost > 0 ? `<li>${plan.features.boost} Boosts</li>` : ''}
                  ${plan.features.no_ads ? '<li>No Ads</li>' : ''}
                </ul>
                <button onclick="subscribe('${plan.id}')" ${state.subscription ? 'disabled' : ''}>
                  ${state.subscription ? 'Subscribed' : 'Subscribe'}
                </button>
              </div>
            `).join('')}
            <div class="text-center mt-3">
              <button class="btn-secondary" onclick="changeScreen('explore')">Back to App</button>
            </div>
          </div>
        </div>
        ${renderNav('subscription')}
      `
    }

    function renderNav(active) {
      return `
        <div class="nav">
          <button class="nav-btn ${active === 'explore' ? 'active' : ''}" onclick="changeScreen('explore')">
            <span>üî•</span>
            Explore
          </button>
          <button class="nav-btn ${active === 'matches' ? 'active' : ''}" onclick="changeScreen('matches')">
            <span>üíï</span>
            Matches
          </button>
          <button class="nav-btn ${active === 'chat' ? 'active' : ''}" onclick="changeScreen('chat')">
            <span>üí¨</span>
            Chat
          </button>
          <button class="nav-btn ${active === 'subscription' ? 'active' : ''}" onclick="changeScreen('subscription')">
            <span>‚≠ê</span>
            Premium
          </button>
        </div>
      `
    }

    // ============================================
    // MAIN RENDER
    // ============================================
    function render() {
      const app = document.getElementById('app')
      let html = ''

      switch (state.screen) {
        case 'loading':
          html = renderLoading()
          break
        case 'notWorldApp':
          html = renderNotWorldApp()
          break
        case 'signin':
          html = renderSignIn()
          break
        case 'profileSetup':
          html = renderProfileSetup()
          break
        case 'explore':
          html = renderExplore()
          break
        case 'matches':
          html = renderMatches()
          break
        case 'chat':
          html = renderChat()
          break
        case 'subscription':
          html = renderSubscription()
          break
      }

      app.innerHTML = html
    }

    // ============================================
    // INIT
    // ============================================
    async function init() {
      console.log('App starting...')
      
      setTimeout(async () => {
        const isInstalled = MiniKit.isInstalled()
        console.log('World App detected:', isInstalled)

        if (!isInstalled) {
          state.screen = 'notWorldApp'
          render()
          return
        }

        if (state.token) {
          try {
            await loadProfile()
          } catch (error) {
            state.screen = 'signin'
            render()
          }
        } else {
          state.screen = 'signin'
          render()
        }
      }, 1000)
    }

    render()
    init()
    
    console.log('‚úÖ Elite Connect loaded!')
  </script>
</body>
</html> -->

<!-- 
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Elite Connect</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 1rem;
    }
    .container { max-width: 500px; margin: 0 auto; padding-top: 2rem; }
    .card { 
      background: white; 
      padding: 2rem; 
      border-radius: 20px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      margin-bottom: 1rem;
    }
    .logo { font-size: 4rem; text-align: center; margin-bottom: 1rem; }
    h1 { 
      text-align: center;
      background: linear-gradient(135deg, #ec4899, #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;  /* ‚Üê Added for compatibility */
      color: transparent; 
      margin-bottom: 1rem;
    }
    h2 { color: #333; margin-bottom: 1rem; }
    p { color: #666; line-height: 1.6; margin-bottom: 1rem; text-align: center; }
    button {
      background: linear-gradient(135deg, #ec4899, #8b5cf6);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
      margin-top: 0.5rem;
    }
    button:active { transform: scale(0.98); }
    input, select, textarea {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 1rem;
      margin-top: 0.5rem;
    }
    label { display: block; font-weight: 600; color: #333; margin-top: 1rem; }
    .info { 
      background: #e3f2fd; 
      border-left: 4px solid #2196f3; 
      padding: 1rem; 
      margin: 1rem 0;
      border-radius: 5px;
    }
    .error { 
      background: #fee; 
      border-left: 4px solid #f44; 
      padding: 1rem; 
      margin: 1rem 0; 
      color: #c33;
      border-radius: 5px;
    }
    .success { 
      background: #d4edda; 
      border-left: 4px solid #28a745; 
      padding: 1rem; 
      margin: 1rem 0;
      color: #155724;
      border-radius: 5px;
    }
    .user-card {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      text-align: center;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    }
    .user-photo { 
      width: 150px; 
      height: 150px; 
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 50%;
      margin: 0 auto 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 4rem;
    }
    .actions { 
      display: flex; 
      gap: 1rem; 
      justify-content: center; 
      margin-top: 1.5rem; 
    }
    .action-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .pass { background: #ff4444; color: white; }
    .like { background: #00C851; color: white; }
    .super { background: #ffbb33; color: white; }
    .nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      display: flex;
      justify-content: space-around;
      padding: 0.75rem;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }
    .nav button {
      background: none;
      color: #666;
      border: none;
      padding: 0.5rem;
      cursor: pointer;
      font-size: 0.9rem;
      width: auto;
      margin: 0;
    }
    .nav button.active { color: #8b5cf6; font-weight: bold; }
    .match-item {
      background: white;
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      cursor: pointer;
    }
    .match-item:hover { background: #f8f9fa; }
    .match-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }
    .chat-messages {
      height: 400px;
      overflow-y: auto;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 10px;
      margin-bottom: 1rem;
    }
    .message {
      background: white;
      padding: 0.75rem;
      border-radius: 10px;
      margin-bottom: 0.5rem;
      max-width: 80%;
    }
    .message.own {
      background: #8b5cf6;
      color: white;
      margin-left: auto;
    }
    .message-input {
      display: flex;
      gap: 0.5rem;
    }
    .message-input input {
      flex: 1;
      margin: 0;
    }
    .message-input button {
      width: auto;
      padding: 0.75rem 1.5rem;
      margin: 0;
    }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    // Import MiniKit
    import { MiniKit, VerificationLevel } from 'https://cdn.jsdelivr.net/npm/@worldcoin/minikit-js@1.9.6/+esm'

    console.log('‚úÖ App loading...')

    // ============================================
    // CONFIGURATION - CHANGE THESE!
    // ============================================
    const APP_ID = 'app_486e187afe7bc69a19456a3fa901a162'
 // const API_URL = 'https://elite-connect-backend-ktv9.onrender.com/api' 

//     // Install MiniKit
//     MiniKit.install(APP_ID)
//     console.log('‚úÖ MiniKit installed')

//     // ============================================
//     // STATE
//     // ============================================
//     let state = {
//       screen: 'signin',
//       user: null,
//       profile: null,
//       token: localStorage.getItem('token'),
//       error: null,
//       users: [],
//       currentUserIndex: 0,
//       matches: [],
//       chats: [],
//       currentChat: null,
//       messages: []
//     }

//     // ============================================
//     // API
//     // ============================================
//     async function api(endpoint, options = {}) {
//       const headers = { 'Content-Type': 'application/json' }
//       if (state.token) headers['Authorization'] = `Bearer ${state.token}`
      
//       const response = await fetch(`${API_URL}${endpoint}`, { ...options, headers })
//       return response.json()
//     }

//     // ============================================
//     // 1. SIGN IN
//     // ============================================
//     async function signIn() {
//       try {
//         console.log('üîê Sign in started')
//         state.error = null
//         render()
        
//         // IMPORTANT: Use Orb verification!
//         const { finalPayload } = await MiniKit.commandsAsync.verify({
//           action: 'login',
//           signal: '',
//           verification_level: VerificationLevel.Orb
//         })

//         console.log('‚úÖ Verification status:', finalPayload.status)

//         if (finalPayload.status === 'success') {
//           const data = await api('/api/auth/verify', {
//             method: 'POST',
//             body: JSON.stringify({ payload: finalPayload, action: 'login' })
//           })

//           if (data.success) {
//             console.log('‚úÖ Auth successful!')
//             state.user = data.user
//             state.token = data.token
//             localStorage.setItem('token', data.token)
//             await checkProfile()
//           } else {
//             throw new Error(data.error || 'Auth failed')
//           }
//         } else {
//           throw new Error('Verification failed')
//         }
//       } catch (error) {
//         console.error('‚ùå Error:', error)
//         state.error = error.message
//         state.screen = 'signin'
//         render()
//       }
//     }

//     // ============================================
//     // 2. CHECK PROFILE
//     // ============================================
//     async function checkProfile() {
//       try {
//         const data = await api('/api/profile/me')
//         if (data.profile) {
//           state.profile = data.profile
//           state.screen = 'explore'
//           await loadUsers()
//         } else {
//           state.screen = 'profile'
//         }
//         render()
//       } catch (error) {
//         state.screen = 'profile'
//         render()
//       }
//     }

//     // ============================================
//     // 3. CREATE PROFILE
//     // ============================================
//     async function createProfile(e) {
//       e.preventDefault()
//       try {
//         const formData = {
//           name: document.getElementById('name').value,
//           age: parseInt(document.getElementById('age').value),
//           gender: document.getElementById('gender').value,
//           bio: document.getElementById('bio').value || '',
//           interests: (document.getElementById('interests').value || '').split(',').map(i => i.trim()).filter(Boolean)
//         }

//         const data = await api('/api/profile/create', {
//           method: 'POST',
//           body: JSON.stringify(formData)
//         })

//         if (data.success) {
//           console.log('‚úÖ Profile created!')
//           state.profile = data.profile
//           state.screen = 'explore'
//           await loadUsers()
//           render()
//         } else {
//           alert('Error: ' + data.error)
//         }
//       } catch (error) {
//         alert('Error: ' + error.message)
//       }
//     }

//     // ============================================
//     // 4. EXPLORE (SWIPE)
//     // ============================================
//     async function loadUsers() {
//       try {
//         const data = await api('/api/explore/users', { method: 'POST' })
//         if (data.success) {
//           state.users = data.users
//           state.currentUserIndex = 0
//         }
//       } catch (error) {
//         console.error('Error loading users:', error)
//       }
//     }

//     async function swipe(action) {
//       if (state.currentUserIndex >= state.users.length) {
//         await loadUsers()
//         return
//       }

//       const user = state.users[state.currentUserIndex]
      
//       try {
//         const data = await api('/api/explore/swipe', {
//           method: 'POST',
//           body: JSON.stringify({ target_user_id: user.id, action })
//         })

//         if (data.success && data.is_match) {
//           alert(`üéâ It's a Match with ${user.name}!`)
//         }
        
//         state.currentUserIndex++
//         render()
//       } catch (error) {
//         console.error('Swipe error:', error)
//       }
//     }

//     // ============================================
//     // 5. MATCHES
//     // ============================================
//     async function loadMatches() {
//       try {
//         const data = await api('/api/explore/matches')
//         if (data.success) {
//           state.matches = data.matches
//           render()
//         }
//       } catch (error) {
//         console.error('Error loading matches:', error)
//       }
//     }

//     // ============================================
//     // 6. CHAT
//     // ============================================
//     async function loadChats() {
//       try {
//         const data = await api('/api/chat/conversations')
//         if (data.success) {
//           state.chats = data.conversations
//           render()
//         }
//       } catch (error) {
//         console.error('Error loading chats:', error)
//       }
//     }

//     async function openChat(matchId) {
//       state.currentChat = matchId
//       await loadMessages(matchId)
//       render()
//     }

//     async function loadMessages(matchId) {
//       try {
//         const data = await api(`/api/chat/messages/${matchId}`)
//         if (data.success) {
//           state.messages = data.messages
//           render()
//           setTimeout(() => {
//             const div = document.getElementById('messages')
//             if (div) div.scrollTop = div.scrollHeight
//           }, 100)
//         }
//       } catch (error) {
//         console.error('Error loading messages:', error)
//       }
//     }

//     async function sendMessage() {
//       const input = document.getElementById('messageInput')
//       const text = input.value.trim()
//       if (!text) return

//       try {
//         const data = await api('/api/chat/send', {
//           method: 'POST',
//           body: JSON.stringify({ match_id: state.currentChat, text })
//         })

//         if (data.success) {
//           input.value = ''
//           await loadMessages(state.currentChat)
//         }
//       } catch (error) {
//         console.error('Send error:', error)
//       }
//     }

//     // ============================================
//     // NAVIGATION
//     // ============================================
//     function goTo(screen) {
//       state.screen = screen
//       state.currentChat = null
      
//       if (screen === 'explore') loadUsers()
//       else if (screen === 'matches') loadMatches()
//       else if (screen === 'chat') loadChats()
      
//       render()
//     }

//     // ============================================
//     // RENDER
//     // ============================================
//     function render() {
//       const app = document.getElementById('app')
      
//       if (state.screen === 'signin') {
//         app.innerHTML = `
//           <div class="container">
//             <div class="card">
//               <div class="logo">üíï</div>
//               <h1>Elite Connect</h1>
//               <p>Verified connections, genuine hearts</p>
//               ${state.error ? `<div class="error">‚ö†Ô∏è ${state.error}</div>` : ''}
//               <button onclick="window.signIn()">üåç Sign in with World ID</button>
//               <div class="info">
//                 ‚úì Orb-verified authentication<br>
//                 ‚úì One person, one profile<br>
//                 ‚úì Verified humans only
//               </div>
//             </div>
//           </div>
//         `
//       }
//       else if (state.screen === 'profile') {
//         app.innerHTML = `
//           <div class="container">
//             <div class="card">
//               <div class="logo">‚ú®</div>
//               <h1>Create Profile</h1>
//               <form onsubmit="window.createProfile(event)">
//                 <label>Name *</label>
//                 <input type="text" id="name" required placeholder="Your name">
                
//                 <label>Age *</label>
//                 <input type="number" id="age" required min="18" max="100">
                
//                 <label>Gender *</label>
//                 <select id="gender" required>
//                   <option value="">Select</option>
//                   <option value="male">Male</option>
//                   <option value="female">Female</option>
//                   <option value="other">Other</option>
//                 </select>
                
//                 <label>Bio</label>
//                 <textarea id="bio" rows="3" placeholder="Tell us about yourself..."></textarea>
                
//                 <label>Interests (comma-separated)</label>
//                 <input type="text" id="interests" placeholder="hiking, music, travel">
                
//                 <button type="submit">‚úÖ Create Profile</button>
//               </form>
//             </div>
//           </div>
//         `
//       }
//       else if (state.screen === 'explore') {
//         const user = state.users[state.currentUserIndex]
//         if (!user) {
//           app.innerHTML = `
//             <div class="container">
//               <div class="card">
//                 <h2>üîç No More Users</h2>
//                 <p>Check back later!</p>
//                 <button onclick="window.loadUsers()">üîÑ Refresh</button>
//               </div>
//             </div>
//             ${renderNav('explore')}
//           `
//         } else {
//           const emoji = user.gender === 'male' ? 'üë®' : user.gender === 'female' ? 'üë©' : 'üßë'
//           app.innerHTML = `
//             <div class="container" style="padding-bottom: 80px;">
//               <h2 style="color: white; text-align: center; margin-bottom: 1rem;">üî• Discover</h2>
//               <div class="user-card">
//                 <div class="user-photo">${emoji}</div>
//                 <h2>${user.name}, ${user.age}</h2>
//                 <p style="color: #666;">${user.bio || 'No bio'}</p>
//                 ${user.interests && user.interests.length > 0 ? 
//                   `<p><strong>Interests:</strong> ${user.interests.join(', ')}</p>` : ''}
//                 <div class="actions">
//                   <button class="action-btn pass" onclick="window.swipe('pass')">‚úñÔ∏è</button>
//                   <button class="action-btn like" onclick="window.swipe('like')">üíö</button>
//                   <button class="action-btn super" onclick="window.swipe('super_like')">‚≠ê</button>
//                 </div>
//               </div>
//             </div>
//             ${renderNav('explore')}
//           `
//         }
//       }
//       else if (state.screen === 'matches') {
//         app.innerHTML = `
//           <div class="container" style="padding-bottom: 80px;">
//             <div class="card">
//               <h2>üíï Your Matches</h2>
//               ${state.matches.length === 0 ? `
//                 <p>No matches yet. Keep swiping!</p>
//                 <button onclick="window.goTo('explore')">Start Swiping</button>
//               ` : state.matches.map(match => {
//                 const emoji = match.user.gender === 'male' ? 'üë®' : match.user.gender === 'female' ? 'üë©' : 'üßë'
//                 return `
//                   <div class="match-item" onclick="window.openChat('${match.match_id}')">
//                     <div class="match-avatar">${emoji}</div>
//                     <div>
//                       <strong>${match.user.name}, ${match.user.age}</strong><br>
//                       <small>Matched ${new Date(match.matched_at).toLocaleDateString()}</small>
//                     </div>
//                   </div>
//                 `
//               }).join('')}
//             </div>
//           </div>
//           ${renderNav('matches')}
//         `
//       }
//       else if (state.screen === 'chat') {
//         if (!state.currentChat) {
//           app.innerHTML = `
//             <div class="container" style="padding-bottom: 80px;">
//               <div class="card">
//                 <h2>üí¨ Messages</h2>
//                 ${state.chats.length === 0 ? `
//                   <p>No conversations yet</p>
//                   <button onclick="window.goTo('matches')">View Matches</button>
//                 ` : state.chats.map(chat => {
//                   const emoji = chat.user?.gender === 'male' ? 'üë®' : chat.user?.gender === 'female' ? 'üë©' : 'üßë'
//                   return `
//                     <div class="match-item" onclick="window.openChat('${chat.match_id}')">
//                       <div class="match-avatar">${emoji}</div>
//                       <div>
//                         <strong>${chat.user?.name || 'User'}</strong><br>
//                         <small>${chat.last_message ? chat.last_message.text.substring(0, 40) + '...' : 'Say hi!'}</small>
//                       </div>
//                     </div>
//                   `
//                 }).join('')}
//               </div>
//             </div>
//             ${renderNav('chat')}
//           `
//         } else {
//           const chat = state.chats.find(c => c.match_id === state.currentChat)
//           const userName = chat?.user?.name || 'User'
//           app.innerHTML = `
//             <div class="container" style="padding-bottom: 80px;">
//               <div class="card">
//                 <button onclick="window.goTo('chat')" style="width: auto; padding: 0.5rem 1rem; margin-bottom: 1rem;">‚Üê Back</button>
//                 <h2>${userName}</h2>
//                 <div class="chat-messages" id="messages">
//                   ${state.messages.length === 0 ? 
//                     '<p style="text-align: center; color: #999;">No messages yet. Say hi!</p>' :
//                     state.messages.map(msg => `
//                       <div class="message ${msg.is_mine ? 'own' : ''}">
//                         <p>${msg.text}</p>
//                         <small>${new Date(msg.created_at).toLocaleTimeString()}</small>
//                       </div>
//                     `).join('')
//                   }
//                 </div>
//                 <div class="message-input">
//                   <input type="text" id="messageInput" placeholder="Type a message..." 
//                     onkeypress="if(event.key==='Enter') window.sendMessage()">
//                   <button onclick="window.sendMessage()">Send</button>
//                 </div>
//               </div>
//             </div>
//             ${renderNav('chat')}
//           `
//         }
//       }
//     }

//     function renderNav(active) {
//       return `
//         <div class="nav">
//           <button class="${active === 'explore' ? 'active' : ''}" onclick="window.goTo('explore')">
//             üî• Explore
//           </button>
//           <button class="${active === 'matches' ? 'active' : ''}" onclick="window.goTo('matches')">
//             üíï Matches
//           </button>
//           <button class="${active === 'chat' ? 'active' : ''}" onclick="window.goTo('chat')">
//             üí¨ Chat
//           </button>
//         </div>
//       `
//     }

//     // ============================================
//     // EXPOSE FUNCTIONS
//     // ============================================
//     window.signIn = signIn
//     window.createProfile = createProfile
//     window.swipe = swipe
//     window.goTo = goTo
//     window.openChat = openChat
//     window.sendMessage = sendMessage
//     window.loadUsers = loadUsers

//     // ============================================
//     // INIT
//     // ============================================
//     async function init() {
//       if (state.token) {
//         try {
//           await checkProfile()
//         } catch (error) {
//           state.screen = 'signin'
//           render()
//         }
//       } else {
//         render()
//       }
//     }

//     render()
//     init()
//     console.log('‚úÖ App loaded!')
//   </script>
// </body>
// </html> -->

<!-- <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Elite Connect</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 1rem;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    .card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      min-height: 700px; /* Increased height */
      max-height: 85vh;
      display: flex;
      flex-direction: column;
    }
    
    /* Content area */
    .content {
      flex: 1;
      padding: 2rem;
      overflow-y: auto;
    }
    
    /* Bottom Navigation INSIDE card */
    .bottom-nav {
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 0.75rem 0;
      border-top: 2px solid #e0e0e0;
      background: white;
      border-radius: 0 0 20px 20px;
      flex-shrink: 0;
    }
    .nav-icon {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.5rem;
      color: #999;
      transition: all 0.2s;
    }
    .nav-icon:hover { transform: scale(1.1); }
    .nav-icon.active { color: #8b5cf6; }
    .nav-icon span { font-size: 1.5rem; margin-bottom: 0.25rem; }
    .nav-icon small { font-size: 0.7rem; }
    
    /* Confirmation Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
    .modal.show {
      display: flex;
    }
    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 20px;
      max-width: 400px;
      width: 90%;
      text-align: center;
    }
    .modal-buttons {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
    }
    .modal-buttons button {
      flex: 1;
      margin: 0;
    }
    
    .logo { font-size: 4rem; text-align: center; margin-bottom: 1rem; }
    h1 {
      text-align: center;
      background: linear-gradient(135deg, #ec4899, #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 1rem;
      font-size: 2rem;
    }
    h2 { color: #333; margin-bottom: 1rem; font-size: 1.5rem; }
    p { color: #666; line-height: 1.6; margin-bottom: 1rem; }
    
    button {
      background: linear-gradient(135deg, #ec4899, #8b5cf6);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
      margin-top: 0.5rem;
    }
    button:hover { opacity: 0.9; }
    button:active { transform: scale(0.98); }
    .btn-small { padding: 0.5rem 1rem; width: auto; font-size: 0.875rem; }
    .btn-secondary { background: linear-gradient(135deg, #3b82f6, #2563eb); }
    .btn-cancel { background: linear-gradient(135deg, #6b7280, #4b5563); }
    
    input, select, textarea {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 1rem;
      margin-top: 0.5rem;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #8b5cf6;
    }
    label { display: block; font-weight: 600; color: #333; margin-top: 1rem; }
    
    .user-card {
      text-align: center;
      padding: 1rem;
    }
    .user-photo {
      width: 150px;
      height: 150px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 50%;
      margin: 0 auto 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 4rem;
    }
    .actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 1.5rem;
    }
    .action-btn {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      border: none;
      font-size: 2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      margin: 0;
      transition: transform 0.2s;
    }
    .action-btn:hover { transform: scale(1.1); }
    .pass { background: #ff4444; color: white; }
    .like { background: #00C851; color: white; }
    .super { background: #ffbb33; color: white; }
    
    .user-item {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      cursor: pointer;
    }
    .user-item:hover { background: #e9ecef; }
    .user-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      flex-shrink: 0;
    }
    
    .chat-messages {
      height: 350px;
      overflow-y: auto;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 10px;
      margin-bottom: 1rem;
    }
    .message {
      background: white;
      padding: 0.75rem 1rem;
      border-radius: 10px;
      margin-bottom: 0.5rem;
      max-width: 80%;
      word-wrap: break-word;
    }
    .message.own {
      background: #8b5cf6;
      color: white;
      margin-left: auto;
    }
    .message-time {
      font-size: 0.75rem;
      opacity: 0.7;
      margin-top: 0.25rem;
    }
    .message-input {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    .message-input input {
      flex: 1;
      margin: 0;
    }
    .message-input button {
      width: auto;
      padding: 0.75rem 1.5rem;
      margin: 0;
    }
    
    .info {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 5px;
      font-size: 0.9rem;
    }
    .badge {
      display: inline-block;
      background: #8b5cf6;
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      margin: 0.25rem;
    }
    .empty {
      text-align: center;
      padding: 3rem 1rem;
      color: #999;
    }
    .empty .logo { opacity: 0.3; font-size: 3rem; }
    
    .wallet-section {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 2rem;
      border-radius: 15px;
      margin-bottom: 1.5rem;
    }
    .balance {
      font-size: 2.5rem;
      font-weight: bold;
      text-align: center;
      margin: 1rem 0;
    }
    
    .profile-header {
      text-align: center;
      padding: 1rem;
      border-bottom: 2px solid #e0e0e0;
      margin-bottom: 1.5rem;
    }
    .profile-photo {
      width: 120px;
      height: 120px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 50%;
      margin: 0 auto 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
    }
    .profile-info {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <div id="app"></div>
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <div class="logo">üíï</div>
      <h2 id="modalTitle">Confirm Action</h2>
      <p id="modalMessage">Do you want to like this profile?</p>
      <div class="modal-buttons">
        <button class="btn-cancel" onclick="cancelAction()">‚ùå Cancel</button>
        <button onclick="confirmAction()">‚úÖ Accept</button>
      </div>
    </div>
  </div>

  <script>
    console.log('üöÄ Elite Connect - Starting...')

    // ============================================
    // CONFIGURATION
    // ============================================
    const API_URL = 'http://localhost:5002'

    // ============================================
    // STATE
    // ============================================
    let state = {
      screen: 'signin',
      user: null,
      profile: null,
      token: localStorage.getItem('demo_token'),
      users: [],
      currentUserIndex: 0,
      allUsers: [],
      currentChatUser: null,
      messages: [],
      pendingAction: null // For confirmation modal
    }

    // ============================================
    // API FUNCTIONS
    // ============================================
    async function api(endpoint, options = {}) {
      const headers = { 'Content-Type': 'application/json' }
      if (state.token) headers['Authorization'] = `Bearer ${state.token}`
      
      try {
        const response = await fetch(`${API_URL}${endpoint}`, { ...options, headers })
        const data = await response.json()
        return data
      } catch (error) {
        console.error('API Error:', error)
        return { success: false, error: error.message }
      }
    }

    // ============================================
    // AUTH
    // ============================================
    async function demoSignIn() {
      try {
        console.log('üîê Demo sign in...')
        
        const demoUser = {
          id: 'demo_' + Date.now(),
          nullifier_hash: 'demo_hash_' + Date.now()
        }

        const data = await api('/api/auth/verify', {
          method: 'POST',
          body: JSON.stringify({
            payload: {
              nullifier_hash: demoUser.nullifier_hash,
              verification_level: 'orb'
            },
            action: 'login'
          })
        })

        if (data.success) {
          console.log('‚úÖ Demo auth successful!')
          state.user = data.user
          state.token = data.token
          localStorage.setItem('demo_token', data.token)
          await checkProfile()
        } else {
          alert('Backend error: ' + data.error)
        }
      } catch (error) {
        console.error('‚ùå Sign in error:', error)
        alert('Error: ' + error.message)
      }
    }

    // ============================================
    // PROFILE
    // ============================================
    async function checkProfile() {
      try {
        const data = await api('/api/profile/me')
        if (data.profile) {
          state.profile = data.profile
          state.screen = 'home'
          await loadUsers()
        } else {
          state.screen = 'profile-setup'
        }
        render()
      } catch (error) {
        state.screen = 'profile-setup'
        render()
      }
    }

    async function createProfile(e) {
      e.preventDefault()
      try {
        const formData = {
          name: document.getElementById('name').value,
          age: parseInt(document.getElementById('age').value),
          gender: document.getElementById('gender').value,
          bio: document.getElementById('bio').value || '',
          interests: (document.getElementById('interests').value || '')
            .split(',')
            .map(i => i.trim())
            .filter(Boolean)
        }

        const data = await api('/api/profile/create', {
          method: 'POST',
          body: JSON.stringify(formData)
        })

        if (data.success) {
          console.log('‚úÖ Profile created!')
          state.profile = data.profile
          state.screen = 'home'
          await loadUsers()
          render()
        } else {
          alert('Error: ' + data.error)
        }
      } catch (error) {
        alert('Error: ' + error.message)
      }
    }

    // ============================================
    // USERS & EXPLORE
    // ============================================
    async function loadUsers() {
      try {
        const data = await api('/api/explore/users', { method: 'POST' })
        if (data.success) {
          state.users = data.users
          state.currentUserIndex = 0
          render()
        }
      } catch (error) {
        console.error('Error loading users:', error)
      }
    }

    async function loadAllUsers() {
      try {
        // Load all users
        const usersData = await api('/api/explore/users', { method: 'POST' })
        
        // Load users you've liked
        const likedData = await api('/api/explore/liked')
        
        if (usersData.success) {
          // Mark liked users
          const likedIds = new Set((likedData.users || []).map(u => u.id))
          
          state.allUsers = usersData.users.map(user => ({
            ...user,
            isLiked: likedIds.has(user.id)
          }))
          
          // Sort: liked users first
          state.allUsers.sort((a, b) => {
            if (a.isLiked && !b.isLiked) return -1
            if (!a.isLiked && b.isLiked) return 1
            return 0
          })
          
          render()
        }
      } catch (error) {
        console.error('Error loading all users:', error)
      }
    }

    // ============================================
    // CONFIRMATION MODAL
    // ============================================
    function showConfirmation(action, userName) {
      const modal = document.getElementById('confirmModal')
      const title = document.getElementById('modalTitle')
      const message = document.getElementById('modalMessage')
      
      if (action === 'like') {
        title.textContent = 'üíö Like Profile?'
        message.textContent = `Do you want to like ${userName}?`
      } else if (action === 'super_like') {
        title.textContent = '‚≠ê Super Like?'
        message.textContent = `Do you want to super like ${userName}?`
      }
      
      state.pendingAction = action
      modal.classList.add('show')
    }

    function cancelAction() {
      console.log('‚ùå Action cancelled')
      const modal = document.getElementById('confirmModal')
      modal.classList.remove('show')
      state.pendingAction = null
      
      // Move to next user (reject)
      state.currentUserIndex++
      render()
    }

    async function confirmAction() {
      console.log('‚úÖ Action confirmed:', state.pendingAction)
      const modal = document.getElementById('confirmModal')
      modal.classList.remove('show')
      
      // Execute the swipe action
      await executeSwipe(state.pendingAction)
      state.pendingAction = null
    }

    function swipeWithConfirmation(action) {
      if (action === 'pass') {
        // Pass doesn't need confirmation
        swipe(action)
      } else {
        // Like and Super Like need confirmation
        const user = state.users[state.currentUserIndex]
        if (user) {
          showConfirmation(action, user.name)
        }
      }
    }

    async function swipe(action) {
      if (state.currentUserIndex >= state.users.length) {
        await loadUsers()
        return
      }

      await executeSwipe(action)
    }

    async function executeSwipe(action) {
      const user = state.users[state.currentUserIndex]
      
      try {
        const data = await api('/api/explore/swipe', {
          method: 'POST',
          body: JSON.stringify({ target_user_id: user.id, action })
        })

        if (data.success && data.is_match) {
          alert(`üéâ It's a Match with ${user.name}!`)
        }
        
        state.currentUserIndex++
        render()
      } catch (error) {
        console.error('Swipe error:', error)
      }
    }

    // ============================================
    // CHAT
    // ============================================
    async function openChatWithUser(userId, userName) {
      state.currentChatUser = { id: userId, name: userName }
      await loadMessagesWithUser(userId)
      state.screen = 'chat-conversation'
      render()
    }

    async function loadMessagesWithUser(userId) {
      try {
        const data = await api(`/api/chat/messages/user/${userId}`)
        if (data.success) {
          state.messages = data.messages || []
        } else {
          state.messages = []
        }
        render()
        setTimeout(() => {
          const div = document.getElementById('messages')
          if (div) div.scrollTop = div.scrollHeight
        }, 100)
      } catch (error) {
        console.error('Error loading messages:', error)
        state.messages = []
        render()
      }
    }

    function sendMessage() {
      const input = document.getElementById('messageInput')
      if (!input) {
        console.error('‚ùå Message input not found')
        return
      }
      
      const text = input.value.trim()
      if (!text) {
        console.log('‚ö†Ô∏è Empty message')
        return
      }

      console.log('üì§ Sending message:', text)

      // Send to backend
      api('/api/chat/send-direct', {
        method: 'POST',
        body: JSON.stringify({ 
          recipient_id: state.currentChatUser.id,
          text 
        })
      })
      .then(data => {
        console.log('‚úÖ Send response:', data)
        
        if (data.success) {
          input.value = ''
          loadMessagesWithUser(state.currentChatUser.id)
        } else {
          alert('Failed to send: ' + (data.error || 'Unknown error'))
        }
      })
      .catch(error => {
        console.error('‚ùå Send error:', error)
        alert('Error: ' + error.message)
      })
    }

    // ============================================
    // NAVIGATION
    // ============================================
    function goTo(screen) {
      state.screen = screen
      
      if (screen === 'home') loadUsers()
      else if (screen === 'explore') loadUsers()
      else if (screen === 'chat') loadAllUsers()
      
      render()
    }

    function logout() {
      localStorage.removeItem('demo_token')
      state = {
        screen: 'signin',
        user: null,
        profile: null,
        token: null,
        users: [],
        currentUserIndex: 0,
        allUsers: [],
        currentChatUser: null,
        messages: [],
        pendingAction: null
      }
      render()
    }

    // ============================================
    // RENDER
    // ============================================
    function renderBottomNav(active) {
      return `
        <div class="bottom-nav">
          <button class="nav-icon ${active === 'home' ? 'active' : ''}" onclick="goTo('home')">
            <span>üè†</span>
            <small>Home</small>
          </button>
          <button class="nav-icon ${active === 'explore' ? 'active' : ''}" onclick="goTo('explore')">
            <span>üî•</span>
            <small>Explore</small>
          </button>
          <button class="nav-icon ${active === 'chat' ? 'active' : ''}" onclick="goTo('chat')">
            <span>üí¨</span>
            <small>Chat</small>
          </button>
          <button class="nav-icon ${active === 'wallet' ? 'active' : ''}" onclick="goTo('wallet')">
            <span>üí∞</span>
            <small>Wallet</small>
          </button>
          <button class="nav-icon ${active === 'profile' ? 'active' : ''}" onclick="goTo('profile')">
            <span>üë§</span>
            <small>Profile</small>
          </button>
        </div>
      `
    }

    function render() {
      const app = document.getElementById('app')
      
      // SIGN IN SCREEN
      if (state.screen === 'signin') {
        app.innerHTML = `
          <div class="container">
            <div class="card">
              <div class="content">
                <div class="logo">üíï</div>
                <h1>Elite Connect</h1>
                <p style="text-align: center;">Verified connections, genuine hearts</p>
                <button onclick="demoSignIn()">üöÄ Demo Sign In</button>
               
              </div>
            </div>
          </div>
        `
      }
      
      // PROFILE SETUP
      else if (state.screen === 'profile-setup') {
        app.innerHTML = `
          <div class="container">
            <div class="card">
              <div class="content">
                <div class="logo">‚ú®</div>
                <h1>Create Your Profile</h1>
                <form onsubmit="createProfile(event)">
                  <label>Name *</label>
                  <input type="text" id="name" required placeholder="Your name">
                  
                  <label>Age *</label>
                  <input type="number" id="age" required min="18" max="100">
                  
                  <label>Gender *</label>
                  <select id="gender" required>
                    <option value="">Select</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="other">Other</option>
                  </select>
                  
                  <label>Bio</label>
                  <textarea id="bio" rows="3" placeholder="Tell us about yourself..."></textarea>
                  
                  <label>Interests (comma-separated)</label>
                  <input type="text" id="interests" placeholder="hiking, music, travel">
                  
                  <button type="submit">‚úÖ Create Profile</button>
                </form>
              </div>
            </div>
          </div>
        `
      }
      
      // HOME SCREEN
      else if (state.screen === 'home') {
        const user = state.users[state.currentUserIndex]
        app.innerHTML = `
          <div class="container">
            <div class="card">
              <div class="content">
                <h2 style="text-align: center;">üè† Home</h2>
                ${!user ? `
                  <div class="empty">
                    <div class="logo">üîç</div>
                    <p>No more users</p>
                    <button onclick="loadUsers()">üîÑ Refresh</button>
                  </div>
                ` : `
                  <div class="user-card">
                    <div class="user-photo">${user.gender === 'male' ? 'üë®' : user.gender === 'female' ? 'üë©' : 'üßë'}</div>
                    <h2 style="margin: 0;">${user.name}, ${user.age}</h2>
                    <p style="color: #666; margin: 1rem 0;">${user.bio || 'No bio'}</p>
                    ${user.interests && user.interests.length > 0 ? 
                      user.interests.map(i => `<span class="badge">${i}</span>`).join('') : ''}
                    <div class="actions">
                      <button class="action-btn pass" onclick="swipe('pass')">‚úñÔ∏è</button>
                      <button class="action-btn like" onclick="swipeWithConfirmation('like')">üíö</button>
                      <button class="action-btn super" onclick="swipeWithConfirmation('super_like')">‚≠ê</button>
                    </div>
                    <button onclick="openChatWithUser('${user.id}', '${user.name}')" style="margin-top: 1rem;" class="btn-secondary">
                      üí¨ Chat with ${user.name}
                    </button>
                  </div>
                `}
              </div>
              ${renderBottomNav('home')}
            </div>
          </div>
        `
      }
      
      // EXPLORE SCREEN
      else if (state.screen === 'explore') {
        const user = state.users[state.currentUserIndex]
        app.innerHTML = `
          <div class="container">
            <div class="card">
              <div class="content">
                <h2 style="text-align: center;">üî• Explore</h2>
                ${!user ? `
                  <div class="empty">
                    <div class="logo">üîç</div>
                    <p>No more users</p>
                    <button onclick="loadUsers()">üîÑ Refresh</button>
                  </div>
                ` : `
                  <div class="user-card">
                    <div class="user-photo">${user.gender === 'male' ? 'üë®' : user.gender === 'female' ? 'üë©' : 'üßë'}</div>
                    <h2 style="margin: 0;">${user.name}, ${user.age}</h2>
                    <p style="color: #666; margin: 1rem 0;">${user.bio || 'No bio'}</p>
                    ${user.interests && user.interests.length > 0 ? 
                      user.interests.map(i => `<span class="badge">${i}</span>`).join('') : ''}
                    <div class="actions">
                      <button class="action-btn pass" onclick="swipe('pass')">‚úñÔ∏è</button>
                      <button class="action-btn like" onclick="swipeWithConfirmation('like')">üíö</button>
                      <button class="action-btn super" onclick="swipeWithConfirmation('super_like')">‚≠ê</button>
                    </div>
                  </div>
                `}
              </div>
              ${renderBottomNav('explore')}
            </div>
          </div>
        `
      }
      
      // CHAT LIST
      else if (state.screen === 'chat') {
        app.innerHTML = `
          <div class="container">
            <div class="card">
              <div class="content">
                <h2>üí¨ Chat with Users</h2>
                ${state.allUsers.length === 0 ? `
                  <div class="empty">
                    <div class="logo">üí¨</div>
                    <p>Loading users...</p>
                  </div>
                ` : state.allUsers.map(user => {
                  const emoji = user.gender === 'male' ? 'üë®' : user.gender === 'female' ? 'üë©' : 'üßë'
                  const likedBadge = user.isLiked ? 'üíö' : ''
                  return `
                    <div class="user-item" onclick="openChatWithUser('${user.id}', '${user.name}')">
                      <div class="user-avatar">${emoji}</div>
                      <div style="flex: 1;">
                        <strong style="font-size: 1.1rem;">${user.name}, ${user.age} ${likedBadge}</strong><br>
                        <small style="color: #666;">${user.bio || 'No bio'}</small>
                      </div>
                    </div>
                  `
                }).join('')}
              </div>
              ${renderBottomNav('chat')}
            </div>
          </div>
        `
      }
      
      // CHAT CONVERSATION
      else if (state.screen === 'chat-conversation') {
        app.innerHTML = `
          <div class="container">
            <div class="card">
              <div class="content">
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 2px solid #e0e0e0;">
                  <button class="btn-small btn-secondary" onclick="goTo('chat')">‚Üê Back</button>
                  <h2 style="margin: 0;">${state.currentChatUser?.name || 'Chat'}</h2>
                </div>
                <div class="chat-messages" id="messages">
                  ${state.messages.length === 0 ? 
                    '<p style="text-align: center; color: #999; padding: 2rem;">No messages yet. Say hi!</p>' :
                    state.messages.map(msg => `
                      <div class="message ${msg.is_mine ? 'own' : ''}">
                        ${msg.text}
                        <div class="message-time">${new Date(msg.created_at).toLocaleTimeString()}</div>
                      </div>
                    `).join('')
                  }
                </div>
                <div class="message-input">
                  <input type="text" id="messageInput" placeholder="Type a message..." 
                    onkeydown="if(event.key==='Enter') { event.preventDefault(); sendMessage(); }">
                  <button type="button" onclick="sendMessage()">Send</button>
                </div>
              </div>
              ${renderBottomNav('chat')}
            </div>
          </div>
        `
      }
      
      // WALLET SCREEN
      else if (state.screen === 'wallet') {
        app.innerHTML = `
          <div class="container">
            <div class="card">
              <div class="content">
                <h2 style="text-align: center;">üí∞ Wallet</h2>
                <div class="wallet-section">
                  <p style="margin: 0; opacity: 0.9;">Your Balance</p>
                  <div class="balance">$0.00</div>
                  <p style="margin: 0; opacity: 0.8; font-size: 0.9rem;">Coming Soon: World ID Token Integration</p>
                </div>
                <div class="info">
                  <strong>Future Features:</strong><br>
                  ‚Ä¢ Send/Receive tokens<br>
                  ‚Ä¢ Premium features<br>
                  ‚Ä¢ Boost profile visibility<br>
                  ‚Ä¢ Gift virtual items
                </div>
              </div>
              ${renderBottomNav('wallet')}
            </div>
          </div>
        `
      }
      
      // PROFILE SCREEN
      else if (state.screen === 'profile') {
        const emoji = state.profile?.gender === 'male' ? 'üë®' : state.profile?.gender === 'female' ? 'üë©' : 'üßë'
        app.innerHTML = `
          <div class="container">
            <div class="card">
              <div class="content">
                <div class="profile-header">
                  <div class="profile-photo">${emoji}</div>
                  <h2 style="margin: 0;">${state.profile?.name || 'User'}</h2>
                  <p style="color: #666;">${state.profile?.age || ''} years old</p>
                </div>
                
                <div class="profile-info">
                  <strong>Gender:</strong> ${state.profile?.gender || 'Not set'}
                </div>
                
                <div class="profile-info">
                  <strong>Bio:</strong><br>
                  ${state.profile?.bio || 'No bio yet'}
                </div>
                
                ${state.profile?.interests && state.profile.interests.length > 0 ? `
                  <div class="profile-info">
                    <strong>Interests:</strong><br>
                    ${state.profile.interests.map(i => `<span class="badge">${i}</span>`).join('')}
                  </div>
                ` : ''}
                
                <button onclick="logout()" style="background: linear-gradient(135deg, #ff4444, #cc0000);">
                  üö™ Logout
                </button>
              </div>
              ${renderBottomNav('profile')}
            </div>
          </div>
        `
      }
    }

    // ============================================
    // EXPOSE FUNCTIONS
    // ============================================
    window.demoSignIn = demoSignIn
    window.createProfile = createProfile
    window.swipe = swipe
    window.swipeWithConfirmation = swipeWithConfirmation
    window.cancelAction = cancelAction
    window.confirmAction = confirmAction
    window.goTo = goTo
    window.openChatWithUser = openChatWithUser
    window.sendMessage = sendMessage
    window.loadUsers = loadUsers
    window.logout = logout

    // ============================================
    // INIT
    // ============================================
    async function init() {
      if (state.token) {
        try {
          await checkProfile()
        } catch (error) {
          state.screen = 'signin'
          render()
        }
      } else {
        render()
      }
    }

    render()
    init()
    console.log('‚úÖ Elite Connect loaded!')
  </script>
</body>
</html> -->


 <!-- <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Elite Connect</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 1rem;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    .card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      min-height: 700px; /* Increased height */
      max-height: 85vh;
      display: flex;
      flex-direction: column;
    }
    
    /* Content area */
    .content {
      flex: 1;
      padding: 2rem;
      overflow-y: auto;
    }
    
    /* Bottom Navigation INSIDE card */
    .bottom-nav {
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 0.75rem 0;
      border-top: 2px solid #e0e0e0;
      background: white;
      border-radius: 0 0 20px 20px;
      flex-shrink: 0;
    }
    .nav-icon {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.5rem;
      color: #999;
      transition: all 0.2s;
    }
    .nav-icon:hover { transform: scale(1.1); }
    .nav-icon.active { color: #8b5cf6; }
    .nav-icon span { font-size: 1.5rem; margin-bottom: 0.25rem; }
    .nav-icon small { font-size: 0.7rem; }
    
    /* Confirmation Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
    .modal.show {
      display: flex;
    }
    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 20px;
      max-width: 400px;
      width: 90%;
      text-align: center;
    }
    .modal-buttons {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
    }
    .modal-buttons button {
      flex: 1;
      margin: 0;
    }
    
    .logo { font-size: 4rem; text-align: center; margin-bottom: 1rem; }
    h1 {
      text-align: center;
      background: linear-gradient(135deg, #ec4899, #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 1rem;
      font-size: 2rem;
    }
    h2 { color: #333; margin-bottom: 1rem; font-size: 1.5rem; }
    p { color: #666; line-height: 1.6; margin-bottom: 1rem; }
    
    button {
      background: linear-gradient(135deg, #ec4899, #8b5cf6);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
      margin-top: 0.5rem;
    }
    button:hover { opacity: 0.9; }
    button:active { transform: scale(0.98); }
    .btn-small { padding: 0.5rem 1rem; width: auto; font-size: 0.875rem; }
    .btn-secondary { background: linear-gradient(135deg, #3b82f6, #2563eb); }
    .btn-cancel { background: linear-gradient(135deg, #6b7280, #4b5563); }
    
    input, select, textarea {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 1rem;
      margin-top: 0.5rem;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #8b5cf6;
    }
    label { display: block; font-weight: 600; color: #333; margin-top: 1rem; }
    
    .user-card {
      text-align: center;
      padding: 1rem;
    }
    .user-photo {
      width: 150px;
      height: 150px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 50%;
      margin: 0 auto 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 4rem;
    }
    .actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 1.5rem;
    }
    .action-btn {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      border: none;
      font-size: 2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      margin: 0;
      transition: transform 0.2s;
    }
    .action-btn:hover { transform: scale(1.1); }
    .pass { background: #ff4444; color: white; }
    .like { background: #00C851; color: white; }
    .super { background: #ffbb33; color: white; }
    
    .user-item {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      cursor: pointer;
    }
    .user-item:hover { background: #e9ecef; }
    .user-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      flex-shrink: 0;
    }
    
    .chat-messages {
      height: 350px;
      overflow-y: auto;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 10px;
      margin-bottom: 1rem;
    }
    .message {
      background: white;
      padding: 0.75rem 1rem;
      border-radius: 10px;
      margin-bottom: 0.5rem;
      max-width: 80%;
      word-wrap: break-word;
    }
    .message.own {
      background: #8b5cf6;
      color: white;
      margin-left: auto;
    }
    .message-time {
      font-size: 0.75rem;
      opacity: 0.7;
      margin-top: 0.25rem;
    }
    .message-input {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    .message-input input {
      flex: 1;
      margin: 0;
    }
    .message-input button {
      width: auto;
      padding: 0.75rem 1.5rem;
      margin: 0;
    }
    
    .info {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 5px;
      font-size: 0.9rem;
    }
    .badge {
      display: inline-block;
      background: #8b5cf6;
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      margin: 0.25rem;
    }
    .empty {
      text-align: center;
      padding: 3rem 1rem;
      color: #999;
    }
    .empty .logo { opacity: 0.3; font-size: 3rem; }
    
    .wallet-section {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 2rem;
      border-radius: 15px;
      margin-bottom: 1.5rem;
    }
    .balance {
      font-size: 2.5rem;
      font-weight: bold;
      text-align: center;
      margin: 1rem 0;
    }
    
    .profile-header {
      text-align: center;
      padding: 1rem;
      border-bottom: 2px solid #e0e0e0;
      margin-bottom: 1.5rem;
    }
    .profile-photo {
      width: 120px;
      height: 120px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 50%;
      margin: 0 auto 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
    }
    .profile-info {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <div id="app"></div>
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <div class="logo">üíï</div>
      <h2 id="modalTitle">Confirm Action</h2>
      <p id="modalMessage">Do you want to like this profile?</p>
      <div class="modal-buttons">
        <button class="btn-cancel" onclick="cancelAction()">‚ùå Cancel</button>
        <button onclick="confirmAction()">‚úÖ Accept</button>
      </div>
    </div>
  </div>

  <script>
    console.log('üöÄ Elite Connect - Starting...')

    // ============================================
    // CONFIGURATION
    // ============================================
    const API_URL = 'http://localhost:5002'

    // ============================================
    // STATE
    // ============================================
    let state = {
      screen: 'signin',
      user: null,
      profile: null,
      token: localStorage.getItem('demo_token'),
      users: [],
      currentUserIndex: 0,
      allUsers: [],
      currentChatUser: null,
      messages: [],
      pendingAction: null // For confirmation modal
    }

    // ============================================
    // API FUNCTIONS
    // ============================================
    async function api(endpoint, options = {}) {
      const headers = { 'Content-Type': 'application/json' }
      if (state.token) headers['Authorization'] = `Bearer ${state.token}`
      
      try {
        const response = await fetch(`${API_URL}${endpoint}`, { ...options, headers })
        const data = await response.json()
        return data
      } catch (error) {
        console.error('API Error:', error)
        return { success: false, error: error.message }
      }
    }

    // ============================================
    // AUTH
    // ============================================
    async function demoSignIn() {
      try {
        console.log('üîê Demo sign in...')
        
        const demoUser = {
          id: 'demo_' + Date.now(),
          nullifier_hash: 'demo_hash_' + Date.now()
        }

        const data = await api('/api/auth/verify', {
          method: 'POST',
          body: JSON.stringify({
            payload: {
              nullifier_hash: demoUser.nullifier_hash,
              verification_level: 'orb'
            },
            action: 'login'
          })
        })

        if (data.success) {
          console.log('‚úÖ Demo auth successful!')
          state.user = data.user
          state.token = data.token
          localStorage.setItem('demo_token', data.token)
          await checkProfile()
        } else {
          alert('Backend error: ' + data.error)
        }
      } catch (error) {
        console.error('‚ùå Sign in error:', error)
        alert('Error: ' + error.message)
      }
    }

    // ============================================
    // PROFILE
    // ============================================
    async function checkProfile() {
      try {
        const data = await api('/api/profile/me')
        if (data.profile) {
          state.profile = data.profile
          state.screen = 'home'
          await loadUsers()
        } else {
          state.screen = 'profile-setup'
        }
        render()
      } catch (error) {
        state.screen = 'profile-setup'
        render()
      }
    }

    async function createProfile(e) {
      e.preventDefault()
      try {
        const formData = {
          name: document.getElementById('name').value,
          age: parseInt(document.getElementById('age').value),
          gender: document.getElementById('gender').value,
          bio: document.getElementById('bio').value || '',
          interests: (document.getElementById('interests').value || '')
            .split(',')
            .map(i => i.trim())
            .filter(Boolean)
        }

        const data = await api('/api/profile/create', {
          method: 'POST',
          body: JSON.stringify(formData)
        })

        if (data.success) {
          console.log('‚úÖ Profile created!')
          state.profile = data.profile
          state.screen = 'home'
          await loadUsers()
          render()
        } else {
          alert('Error: ' + data.error)
        }
      } catch (error) {
        alert('Error: ' + error.message)
      }
    }

    // ============================================
    // USERS & EXPLORE
    // ============================================
    async function loadUsers() {
      try {
        const data = await api('/api/explore/users', { method: 'POST' })
        if (data.success) {
          state.users = data.users
          state.currentUserIndex = 0
          render()
        }
      } catch (error) {
        console.error('Error loading users:', error)
      }
    }

    async function loadAllUsers() {
      try {
        // Load all users
        const usersData = await api('/api/explore/users', { method: 'POST' })
        
        // Load users you've liked
        const likedData = await api('/api/explore/liked')
        
        if (usersData.success) {
          // Mark liked users
          const likedIds = new Set((likedData.users || []).map(u => u.id))
          
          state.allUsers = usersData.users.map(user => ({
            ...user,
            isLiked: likedIds.has(user.id)
          }))
          
          // Sort: liked users first
          state.allUsers.sort((a, b) => {
            if (a.isLiked && !b.isLiked) return -1
            if (!a.isLiked && b.isLiked) return 1
            return 0
          })
          
          render()
        }
      } catch (error) {
        console.error('Error loading all users:', error)
      }
    }

    // ============================================
    // CONFIRMATION MODAL
    // ============================================
    function showConfirmation(action, userName) {
      const modal = document.getElementById('confirmModal')
      const title = document.getElementById('modalTitle')
      const message = document.getElementById('modalMessage')
      
      if (action === 'like') {
        title.textContent = 'üíö Like Profile?'
        message.textContent = `Do you want to like ${userName}?`
      } else if (action === 'super_like') {
        title.textContent = '‚≠ê Super Like?'
        message.textContent = `Do you want to super like ${userName}?`
      }
      
      state.pendingAction = action
      modal.classList.add('show')
    }

    function cancelAction() {
      console.log('‚ùå Action cancelled')
      const modal = document.getElementById('confirmModal')
      modal.classList.remove('show')
      state.pendingAction = null
      
      // Just close modal, stay on same user
      // Don't skip to next user
      // render() not needed - user stays visible
    }

    async function confirmAction() {
      console.log('‚úÖ Action confirmed:', state.pendingAction)
      const modal = document.getElementById('confirmModal')
      modal.classList.remove('show')
      
      // Execute the swipe action
      await executeSwipe(state.pendingAction)
      state.pendingAction = null
    }

    function swipeWithConfirmation(action) {
      if (action === 'pass') {
        // Pass doesn't need confirmation
        swipe(action)
      } else {
        // Like and Super Like need confirmation
        const user = state.users[state.currentUserIndex]
        if (user) {
          showConfirmation(action, user.name)
        }
      }
    }

    async function swipe(action) {
      if (state.currentUserIndex >= state.users.length) {
        await loadUsers()
        return
      }

      await executeSwipe(action)
    }

    async function executeSwipe(action) {
      const user = state.users[state.currentUserIndex]
      
      try {
        const data = await api('/api/explore/swipe', {
          method: 'POST',
          body: JSON.stringify({ target_user_id: user.id, action })
        })

        if (data.success && data.is_match) {
          alert(`üéâ It's a Match with ${user.name}!`)
        }
        
        state.currentUserIndex++
        render()
      } catch (error) {
        console.error('Swipe error:', error)
      }
    }

    // ============================================
    // CHAT
    // ============================================
    async function openChatWithUser(userId, userName) {
      state.currentChatUser = { id: userId, name: userName }
      await loadMessagesWithUser(userId)
      state.screen = 'chat-conversation'
      render()
    }

    async function loadMessagesWithUser(userId) {
      try {
        const data = await api(`/api/chat/messages/user/${userId}`)
        if (data.success) {
          state.messages = data.messages || []
        } else {
          state.messages = []
        }
        render()
        setTimeout(() => {
          const div = document.getElementById('messages')
          if (div) div.scrollTop = div.scrollHeight
        }, 100)
      } catch (error) {
        console.error('Error loading messages:', error)
        state.messages = []
        render()
      }
    }

    function sendMessage() {
      const input = document.getElementById('messageInput')
      if (!input) {
        console.error('‚ùå Message input not found')
        return
      }
      
      const text = input.value.trim()
      if (!text) {
        console.log('‚ö†Ô∏è Empty message')
        return
      }

      console.log('üì§ Sending message:', text)

      // Send to backend
      api('/api/chat/send-direct', {
        method: 'POST',
        body: JSON.stringify({ 
          recipient_id: state.currentChatUser.id,
          text 
        })
      })
      .then(data => {
        console.log('‚úÖ Send response:', data)
        
        if (data.success) {
          input.value = ''
          loadMessagesWithUser(state.currentChatUser.id)
        } else {
          alert('Failed to send: ' + (data.error || 'Unknown error'))
        }
      })
      .catch(error => {
        console.error('‚ùå Send error:', error)
        alert('Error: ' + error.message)
      })
    }

    // ============================================
    // NAVIGATION
    // ============================================
    function goTo(screen) {
      state.screen = screen
      
      if (screen === 'home') loadUsers()
      else if (screen === 'explore') loadUsers()
      else if (screen === 'chat') loadAllUsers()
      
      render()
    }

    function logout() {
      localStorage.removeItem('demo_token')
      state = {
        screen: 'signin',
        user: null,
        profile: null,
        token: null,
        users: [],
        currentUserIndex: 0,
        allUsers: [],
        currentChatUser: null,
        messages: [],
        pendingAction: null
      }
      render()
    }

    // ============================================
    // RENDER
    // ============================================
    function renderBottomNav(active) {
      return `
        <div class="bottom-nav">
          <button class="nav-icon ${active === 'home' ? 'active' : ''}" onclick="goTo('home')">
            <span>üè†</span>
            <small>Home</small>
          </button>
          <button class="nav-icon ${active === 'explore' ? 'active' : ''}" onclick="goTo('explore')">
            <span>üî•</span>
            <small>Explore</small>
          </button>
          <button class="nav-icon ${active === 'chat' ? 'active' : ''}" onclick="goTo('chat')">
            <span>üí¨</span>
            <small>Chat</small>
          </button>
          <button class="nav-icon ${active === 'wallet' ? 'active' : ''}" onclick="goTo('wallet')">
            <span>üí∞</span>
            <small>Wallet</small>
          </button>
          <button class="nav-icon ${active === 'profile' ? 'active' : ''}" onclick="goTo('profile')">
            <span>üë§</span>
            <small>Profile</small>
          </button>
        </div>
      `
    }

    function render() {
      const app = document.getElementById('app')
      
      // SIGN IN SCREEN
      if (state.screen === 'signin') {
        app.innerHTML = `
          <div class="container">
            <div class="card">
              <div class="content">
                <div class="logo">üíï</div>
                <h1>Elite Connect</h1>
                <p style="text-align: center;">Verified connections, genuine hearts</p>
                <button onclick="demoSignIn()">üöÄ Demo Sign In</button>
                <div class="info">
                  <strong>Demo Mode:</strong> Testing locally<br>
                  World ID integration ready for mobile
                </div>
              </div>
            </div>
          </div>
        `
      }
      
      // PROFILE SETUP
      else if (state.screen === 'profile-setup') {
        app.innerHTML = `
          <div class="container">
            <div class="card">
              <div class="content">
                <div class="logo">‚ú®</div>
                <h1>Create Your Profile</h1>
                <form onsubmit="createProfile(event)">
                  <label>Name *</label>
                  <input type="text" id="name" required placeholder="Your name">
                  
                  <label>Age *</label>
                  <input type="number" id="age" required min="18" max="100">
                  
                  <label>Gender *</label>
                  <select id="gender" required>
                    <option value="">Select</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="other">Other</option>
                  </select>
                  
                  <label>Bio</label>
                  <textarea id="bio" rows="3" placeholder="Tell us about yourself..."></textarea>
                  
                  <label>Interests (comma-separated)</label>
                  <input type="text" id="interests" placeholder="hiking, music, travel">
                  
                  <button type="submit">‚úÖ Create Profile</button>
                </form>
              </div>
            </div>
          </div>
        `
      }
      
      // HOME SCREEN
      else if (state.screen === 'home') {
        const user = state.users[state.currentUserIndex]
        app.innerHTML = `
          <div class="container">
            <div class="card">
              <div class="content">
                <h2 style="text-align: center;">üè† Home</h2>
                ${!user ? `
                  <div class="empty">
                    <div class="logo">üîç</div>
                    <p>No more users</p>
                    <button onclick="loadUsers()">üîÑ Refresh</button>
                  </div>
                ` : `
                  <div class="user-card">
                    <div class="user-photo">${user.gender === 'male' ? 'üë®' : user.gender === 'female' ? 'üë©' : 'üßë'}</div>
                    <h2 style="margin: 0;">${user.name}, ${user.age}</h2>
                    <p style="color: #666; margin: 1rem 0;">${user.bio || 'No bio'}</p>
                    ${user.interests && user.interests.length > 0 ? 
                      user.interests.map(i => `<span class="badge">${i}</span>`).join('') : ''}
                    <div class="actions">
                      <button class="action-btn pass" onclick="swipe('pass')">‚úñÔ∏è</button>
                      <button class="action-btn like" onclick="swipeWithConfirmation('like')">üíö</button>
                      <button class="action-btn super" onclick="swipeWithConfirmation('super_like')">‚≠ê</button>
                    </div>
                    <button onclick="openChatWithUser('${user.id}', '${user.name}')" style="margin-top: 1rem;" class="btn-secondary">
                      üí¨ Chat with ${user.name}
                    </button>
                  </div>
                `}
              </div>
              ${renderBottomNav('home')}
            </div>
          </div>
        `
      }
      
      // EXPLORE SCREEN
      else if (state.screen === 'explore') {
        const user = state.users[state.currentUserIndex]
        app.innerHTML = `
          <div class="container">
            <div class="card">
              <div class="content">
                <h2 style="text-align: center;">üî• Explore</h2>
                ${!user ? `
                  <div class="empty">
                    <div class="logo">üîç</div>
                    <p>No more users</p>
                    <button onclick="loadUsers()">üîÑ Refresh</button>
                  </div>
                ` : `
                  <div class="user-card">
                    <div class="user-photo">${user.gender === 'male' ? 'üë®' : user.gender === 'female' ? 'üë©' : 'üßë'}</div>
                    <h2 style="margin: 0;">${user.name}, ${user.age}</h2>
                    <p style="color: #666; margin: 1rem 0;">${user.bio || 'No bio'}</p>
                    ${user.interests && user.interests.length > 0 ? 
                      user.interests.map(i => `<span class="badge">${i}</span>`).join('') : ''}
                    <div class="actions">
                      <button class="action-btn pass" onclick="swipe('pass')">‚úñÔ∏è</button>
                      <button class="action-btn like" onclick="swipeWithConfirmation('like')">üíö</button>
                      <button class="action-btn super" onclick="swipeWithConfirmation('super_like')">‚≠ê</button>
                    </div>
                  </div>
                `}
              </div>
              ${renderBottomNav('explore')}
            </div>
          </div>
        `
      }
      
      // CHAT LIST
      else if (state.screen === 'chat') {
        app.innerHTML = `
          <div class="container">
            <div class="card">
              <div class="content">
                <h2>üí¨ Chat with Users</h2>
                ${state.allUsers.length === 0 ? `
                  <div class="empty">
                    <div class="logo">üí¨</div>
                    <p>Loading users...</p>
                  </div>
                ` : state.allUsers.map(user => {
                  const emoji = user.gender === 'male' ? 'üë®' : user.gender === 'female' ? 'üë©' : 'üßë'
                  const likedBadge = user.isLiked ? 'üíö' : ''
                  return `
                    <div class="user-item" onclick="openChatWithUser('${user.id}', '${user.name}')">
                      <div class="user-avatar">${emoji}</div>
                      <div style="flex: 1;">
                        <strong style="font-size: 1.1rem;">${user.name}, ${user.age} ${likedBadge}</strong><br>
                        <small style="color: #666;">${user.bio || 'No bio'}</small>
                      </div>
                    </div>
                  `
                }).join('')}
              </div>
              ${renderBottomNav('chat')}
            </div>
          </div>
        `
      }
      
      // CHAT CONVERSATION
      else if (state.screen === 'chat-conversation') {
        app.innerHTML = `
          <div class="container">
            <div class="card">
              <div class="content">
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 2px solid #e0e0e0;">
                  <button class="btn-small btn-secondary" onclick="goTo('chat')">‚Üê Back</button>
                  <h2 style="margin: 0;">${state.currentChatUser?.name || 'Chat'}</h2>
                </div>
                <div class="chat-messages" id="messages">
                  ${state.messages.length === 0 ? 
                    '<p style="text-align: center; color: #999; padding: 2rem;">No messages yet. Say hi!</p>' :
                    state.messages.map(msg => `
                      <div class="message ${msg.is_mine ? 'own' : ''}">
                        ${msg.text}
                        <div class="message-time">${new Date(msg.created_at).toLocaleTimeString()}</div>
                      </div>
                    `).join('')
                  }
                </div>
                <div class="message-input">
                  <input type="text" id="messageInput" placeholder="Type a message..." 
                    onkeydown="if(event.key==='Enter') { event.preventDefault(); sendMessage(); }">
                  <button type="button" onclick="sendMessage()">Send</button>
                </div>
              </div>
              ${renderBottomNav('chat')}
            </div>
          </div>
        `
      }
      
      // WALLET SCREEN
      else if (state.screen === 'wallet') {
        app.innerHTML = `
          <div class="container">
            <div class="card">
              <div class="content">
                <h2 style="text-align: center;">üí∞ Wallet</h2>
                <div class="wallet-section">
                  <p style="margin: 0; opacity: 0.9;">Your Balance</p>
                  <div class="balance">$0.00</div>
                  <p style="margin: 0; opacity: 0.8; font-size: 0.9rem;">Coming Soon: World ID Token Integration</p>
                </div>
                <div class="info">
                  <strong>Future Features:</strong><br>
                  ‚Ä¢ Send/Receive tokens<br>
                  ‚Ä¢ Premium features<br>
                  ‚Ä¢ Boost profile visibility<br>
                  ‚Ä¢ Gift virtual items
                </div>
              </div>
              ${renderBottomNav('wallet')}
            </div>
          </div>
        `
      }
      
      // PROFILE SCREEN
      else if (state.screen === 'profile') {
        const emoji = state.profile?.gender === 'male' ? 'üë®' : state.profile?.gender === 'female' ? 'üë©' : 'üßë'
        app.innerHTML = `
          <div class="container">
            <div class="card">
              <div class="content">
                <div class="profile-header">
                  <div class="profile-photo">${emoji}</div>
                  <h2 style="margin: 0;">${state.profile?.name || 'User'}</h2>
                  <p style="color: #666;">${state.profile?.age || ''} years old</p>
                </div>
                
                <div class="profile-info">
                  <strong>Gender:</strong> ${state.profile?.gender || 'Not set'}
                </div>
                
                <div class="profile-info">
                  <strong>Bio:</strong><br>
                  ${state.profile?.bio || 'No bio yet'}
                </div>
                
                ${state.profile?.interests && state.profile.interests.length > 0 ? `
                  <div class="profile-info">
                    <strong>Interests:</strong><br>
                    ${state.profile.interests.map(i => `<span class="badge">${i}</span>`).join('')}
                  </div>
                ` : ''}
                
                <button onclick="logout()" style="background: linear-gradient(135deg, #ff4444, #cc0000);">
                  üö™ Logout
                </button>
              </div>
              ${renderBottomNav('profile')}
            </div>
          </div>
        `
      }
    }

    // ============================================
    // EXPOSE FUNCTIONS
    // ============================================
    window.demoSignIn = demoSignIn
    window.createProfile = createProfile
    window.swipe = swipe
    window.swipeWithConfirmation = swipeWithConfirmation
    window.cancelAction = cancelAction
    window.confirmAction = confirmAction
    window.goTo = goTo
    window.openChatWithUser = openChatWithUser
    window.sendMessage = sendMessage
    window.loadUsers = loadUsers
    window.logout = logout

    // ============================================
    // INIT
    // ============================================
    async function init() {
      if (state.token) {
        try {
          await checkProfile()
        } catch (error) {
          state.screen = 'signin'
          render()
        }
      } else {
        render()
      }
    }

    render()
    init()
    console.log('‚úÖ Elite Connect loaded!')
  </script>
</body>
</html> 

 -->


 <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Elite Connect - World Mini App</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    html, body {
      width: 100vw;
      height: 100vh;
      overscroll-behavior: none;
      overflow: hidden;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 1rem;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    
    .card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      min-height: 700px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
    }
    
    .content {
      flex: 1;
      padding: 2rem;
      overflow-y: auto;
    }
    
    .bottom-nav {
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 0.75rem 0;
      border-top: 2px solid #e0e0e0;
      background: white;
      border-radius: 0 0 20px 20px;
      flex-shrink: 0;
    }
    
    .nav-icon {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.5rem;
      color: #999;
      transition: all 0.2s;
    }
    
    .nav-icon:hover { transform: scale(1.1); }
    .nav-icon.active { color: #8b5cf6; }
    .nav-icon span { font-size: 1.5rem; margin-bottom: 0.25rem; }
    .nav-icon small { font-size: 0.7rem; }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
    
    .modal.show { display: flex; }
    
    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 20px;
      max-width: 400px;
      width: 90%;
      text-align: center;
    }
    
    .modal-buttons {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
    }
    
    .modal-buttons button {
      flex: 1;
      margin: 0;
    }
    
    .logo { font-size: 4rem; text-align: center; margin-bottom: 1rem; }
    
    h1 {
      text-align: center;
      background: linear-gradient(135deg, #ec4899, #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
    }
    
    button {
      width: 100%;
      padding: 1rem;
      border: none;
      border-radius: 12px;
      background: linear-gradient(135deg, #ec4899, #8b5cf6);
      color: white;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s;
      margin-top: 1rem;
    }
    
    button:hover { transform: scale(1.02); }
    button:active { transform: scale(0.98); }
    
    .btn-secondary {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
    }
    
    .btn-cancel {
      background: #ef4444;
    }
    
    .btn-small {
      padding: 0.5rem 1rem;
      width: auto;
      font-size: 0.9rem;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      margin: 0.5rem 0 1rem;
      font-size: 1rem;
    }
    
    .user-card {
      text-align: center;
      padding: 2rem 1rem;
    }
    
    .user-photo {
      font-size: 8rem;
      margin: 1rem 0;
    }
    
    .badge {
      display: inline-block;
      padding: 0.5rem 1rem;
      background: #f3e8ff;
      color: #8b5cf6;
      border-radius: 20px;
      margin: 0.25rem;
      font-size: 0.9rem;
    }
    
    .actions {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin: 2rem 0;
    }
    
    .action-btn {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      font-size: 2rem;
      padding: 0;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .action-btn.pass { background: #ef4444; }
    .action-btn.like { background: #22c55e; }
    .action-btn.super { background: #fbbf24; }
    
    .empty {
      text-align: center;
      padding: 4rem 2rem;
      color: #666;
    }
    
    .user-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      margin-bottom: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .user-item:hover {
      border-color: #8b5cf6;
      background: #f9fafb;
    }
    
    .user-avatar {
      font-size: 3rem;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f3e8ff;
      border-radius: 50%;
    }
    
    .chat-messages {
      min-height: 300px;
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 1rem;
      padding: 1rem;
      background: #f9fafb;
      border-radius: 12px;
    }
    
    .message {
      max-width: 70%;
      padding: 0.75rem 1rem;
      border-radius: 12px;
      margin-bottom: 0.5rem;
      background: white;
      border: 2px solid #e0e0e0;
    }
    
    .message.own {
      margin-left: auto;
      background: linear-gradient(135deg, #ec4899, #8b5cf6);
      color: white;
      border-color: transparent;
    }
    
    .message-time {
      font-size: 0.7rem;
      opacity: 0.7;
      margin-top: 0.25rem;
    }
    
    .message-input {
      display: flex;
      gap: 0.5rem;
    }
    
    .message-input input {
      flex: 1;
      margin: 0;
    }
    
    .message-input button {
      width: auto;
      padding: 0.75rem 1.5rem;
      margin: 0;
    }
    
    .info {
      background: #fef3c7;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
      font-size: 0.9rem;
      text-align: center;
    }
    
    .error {
      background: #fee2e2;
      color: #dc2626;
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
    }
    
    .success {
      background: #d1fae5;
      color: #059669;
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
    }
  </style>
</head>
<body>
  <div id="app"></div>
  
  <!-- Confirmation Modal -->
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <div class="logo">üíï</div>
      <h2 id="modalTitle">Confirm Action</h2>
      <p id="modalMessage">Do you want to like this profile?</p>
      <div class="modal-buttons">
        <button class="btn-cancel" onclick="cancelAction()">‚ùå Cancel</button>
        <button onclick="confirmAction()">‚úÖ Accept</button>
      </div>
    </div>
  </div>

  <!-- MiniKit SDK from CDN -->
  <script type="module">
    import { MiniKit } from 'https://cdn.jsdelivr.net/npm/@worldcoin/minikit-js@1.0.2/+esm'
    
    console.log('üöÄ Elite Connect - Starting...')
    console.log('üì¶ MiniKit imported')
    
    // Make MiniKit globally available
    window.MiniKit = MiniKit
    
    // ============================================
    // CONFIGURATION
    // ============================================
    const CONFIG = {
      API_URL: 'https://elite-connect-backend-ktv9.onrender.com',  // ‚úÖ NO /api at end
      APP_ID: 'app_486e187afe7bc69a19456a3fa901a162',
      ACTION_ID: 'signin'
    }
    
    console.log('‚öôÔ∏è Config loaded:', {
      API_URL: CONFIG.API_URL,
      APP_ID: CONFIG.APP_ID,
      ACTION_ID: CONFIG.ACTION_ID
    })
    
    // ============================================
    // STATE
    // ============================================
    let state = {
      screen: 'checking',
      user: null,
      profile: null,
      token: localStorage.getItem('elite_token'),
      users: [],
      currentUserIndex: 0,
      allUsers: [],
      currentChatUser: null,
      messages: [],
      pendingAction: null,
      isWorldApp: false
    }
    
    // ============================================
    // MINIKIT INITIALIZATION
    // ============================================
    function initMiniKit() {
      try {
        console.log('üîß Installing MiniKit...')
        MiniKit.install(CONFIG.APP_ID)
        state.isWorldApp = MiniKit.isInstalled()
        
        console.log('‚úÖ MiniKit installed')
        console.log('üì± Is World App:', state.isWorldApp)
        console.log('üí∞ Wallet:', MiniKit.walletAddress || 'Not connected')
        
        if (state.isWorldApp) {
          console.log('‚úÖ Running inside World App')
          setupWorldIDListener()
        } else {
          console.log('‚ö†Ô∏è Not running in World App')
        }
      } catch (error) {
        console.error('‚ùå MiniKit installation error:', error)
        state.isWorldApp = false
      }
    }
    
    // ============================================
    // WORLD ID AUTHENTICATION
    // ============================================
    function setupWorldIDListener() {
      console.log('üéß Setting up World ID listener...')
      
      MiniKit.subscribe('miniAppVerifyAction', async (payload) => {
        console.log('üîê World ID Response received:', payload)
        
        if (payload.status === 'error') {
          console.error('‚ùå World ID error:', payload)
          alert('Verification failed. Please try again.')
          return
        }
        
        console.log('‚úÖ World ID verification successful on frontend')
        console.log('üì§ Sending proof to backend...')
        
        // Send proof to backend for verification
        try {
          const response = await fetch(`${CONFIG.API_URL}/api/auth/world-id-verify`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              payload: payload,
              action: CONFIG.ACTION_ID
            })
          })
          
          console.log('üì° Backend response status:', response.status)
          
          const data = await response.json()
          console.log('üì• Backend response data:', data)
          
          if (data.success) {
            console.log('‚úÖ Backend verification successful!')
            state.user = data.user
            state.token = data.token
            localStorage.setItem('elite_token', data.token)
            
            if (data.hasProfile) {
              console.log('‚úÖ User has profile, loading home...')
              state.profile = data.profile
              state.screen = 'home'
              await loadUsers()
            } else {
              console.log('‚ÑπÔ∏è No profile found, showing setup...')
              state.screen = 'profile-setup'
            }
            
            render()
          } else {
            console.error('‚ùå Backend verification failed:', data.error)
            alert('Authentication failed: ' + (data.error || 'Unknown error'))
          }
        } catch (error) {
          console.error('‚ùå Backend verification error:', error)
          alert('Failed to verify with backend. Please check your connection.')
        }
      })
      
      console.log('‚úÖ World ID listener setup complete')
    }
    
    function triggerWorldIDVerify() {
      if (!state.isWorldApp) {
        console.error('‚ùå Cannot verify - not in World App')
        alert('This app must be opened in World App')
        return
      }
      
      console.log('üîê Triggering World ID verification...')
      console.log('Action ID:', CONFIG.ACTION_ID)
      
      try {
        MiniKit.commands.verify({
          action: CONFIG.ACTION_ID,
          verification_level: 'orb'
        })
        console.log('‚úÖ World ID verification command sent')
      } catch (error) {
        console.error('‚ùå Error triggering verification:', error)
        alert('Failed to start verification: ' + error.message)
      }
    }
    
    // ============================================
    // API HELPER WITH TIMEOUT
    // ============================================
    async function api(endpoint, options = {}) {
      const url = endpoint.startsWith('http') ? endpoint : `${CONFIG.API_URL}${endpoint}`
      
      console.log('üåê API call:', url)
      
      const defaultOptions = {
        headers: {
          'Content-Type': 'application/json',
          ...(state.token && { 'Authorization': `Bearer ${state.token}` })
        }
      }
      
      // Add 15 second timeout (Render can take time to wake up)
      const controller = new AbortController()
      const timeoutId = setTimeout(() => controller.abort(), 15000)
      
      try {
        const response = await fetch(url, { 
          ...defaultOptions, 
          ...options,
          signal: controller.signal 
        })
        
        clearTimeout(timeoutId)
        
        console.log('üì° Response status:', response.status)
        
        if (!response.ok) {
          throw new Error(`API Error: ${response.status}`)
        }
        
        const data = await response.json()
        console.log('‚úÖ API success:', endpoint)
        return data
      } catch (error) {
        clearTimeout(timeoutId)
        if (error.name === 'AbortError') {
          console.error('‚è±Ô∏è Request timeout - backend may be sleeping')
          throw new Error('Request timeout - backend may be waking up (Render free tier). Please try again in 30 seconds.')
        }
        console.error('‚ùå API error:', error)
        throw error
      }
    }
    
    // ============================================
    // DATA LOADING FUNCTIONS
    // ============================================
    
    async function loadUsers() {
      try {
        console.log('üì• Loading users...')
        const data = await api('/api/explore/users', { method: 'POST' })
        if (data.success) {
          state.users = data.users
          state.currentUserIndex = 0
          console.log('‚úÖ Loaded', data.users.length, 'users')
          render()
        }
      } catch (error) {
        console.error('‚ùå Error loading users:', error)
        alert('Failed to load users: ' + error.message)
      }
    }
    
    async function loadAllUsers() {
      try {
        console.log('üì• Loading all users for chat...')
        const usersData = await api('/api/explore/users', { method: 'POST' })
        const likedData = await api('/api/explore/liked')
        
        if (usersData.success) {
          const likedIds = new Set((likedData.users || []).map(u => u.id))
          
          state.allUsers = usersData.users.map(user => ({
            ...user,
            isLiked: likedIds.has(user.id)
          }))
          
          state.allUsers.sort((a, b) => {
            if (a.isLiked && !b.isLiked) return -1
            if (!a.isLiked && b.isLiked) return 1
            return 0
          })
          
          console.log('‚úÖ Loaded', state.allUsers.length, 'users for chat')
          render()
        }
      } catch (error) {
        console.error('‚ùå Error loading all users:', error)
      }
    }
    
    async function createProfile(e) {
      e.preventDefault()
      console.log('üìù Creating profile...')
      
      try {
        const formData = {
          name: document.getElementById('name').value,
          age: parseInt(document.getElementById('age').value),
          gender: document.getElementById('gender').value,
          bio: document.getElementById('bio').value || '',
          interests: (document.getElementById('interests').value || '')
            .split(',')
            .map(i => i.trim())
            .filter(Boolean)
        }
        
        console.log('Form data:', formData)

        const data = await api('/api/profile/create', {
          method: 'POST',
          body: JSON.stringify(formData)
        })

        if (data.success) {
          console.log('‚úÖ Profile created successfully')
          state.profile = data.profile
          state.screen = 'home'
          await loadUsers()
          render()
        } else {
          console.error('‚ùå Profile creation failed:', data.error)
          alert('Error: ' + data.error)
        }
      } catch (error) {
        console.error('‚ùå Error creating profile:', error)
        alert('Error: ' + error.message)
      }
    }
    
    // ============================================
    // SWIPE FUNCTIONS
    // ============================================
    
    function showConfirmation(action, userName) {
      console.log('‚ùì Showing confirmation:', action, 'for', userName)
      
      const modal = document.getElementById('confirmModal')
      const title = document.getElementById('modalTitle')
      const message = document.getElementById('modalMessage')
      
      if (action === 'like') {
        title.textContent = 'üíö Like Profile?'
        message.textContent = `Do you want to like ${userName}?`
      } else if (action === 'super_like') {
        title.textContent = '‚≠ê Super Like?'
        message.textContent = `Do you want to super like ${userName}?`
      }
      
      state.pendingAction = action
      modal.classList.add('show')
    }

    function cancelAction() {
      console.log('‚ùå Action cancelled')
      const modal = document.getElementById('confirmModal')
      modal.classList.remove('show')
      state.pendingAction = null
    }

    async function confirmAction() {
      console.log('‚úÖ Action confirmed:', state.pendingAction)
      const modal = document.getElementById('confirmModal')
      modal.classList.remove('show')
      await executeSwipe(state.pendingAction)
      state.pendingAction = null
    }

    function swipeWithConfirmation(action) {
      if (action === 'pass') {
        swipe(action)
      } else {
        const user = state.users[state.currentUserIndex]
        if (user) {
          showConfirmation(action, user.name)
        }
      }
    }

    async function swipe(action) {
      if (state.currentUserIndex >= state.users.length) {
        console.log('üîÑ No more users, reloading...')
        await loadUsers()
        return
      }
      await executeSwipe(action)
    }

    async function executeSwipe(action) {
      const user = state.users[state.currentUserIndex]
      console.log('üëâ Swiping', action, 'on', user.name)
      
      try {
        const data = await api('/api/explore/swipe', {
          method: 'POST',
          body: JSON.stringify({ target_user_id: user.id, action })
        })

        if (data.success && data.is_match) {
          console.log('üéâ Match with', user.name)
          alert(`üéâ It's a Match with ${user.name}!`)
        }
        
        state.currentUserIndex++
        console.log('‚û°Ô∏è Moving to next user')
        render()
      } catch (error) {
        console.error('‚ùå Swipe error:', error)
        alert('Failed to swipe: ' + error.message)
      }
    }
    
    // ============================================
    // CHAT FUNCTIONS
    // ============================================
    
    async function openChatWithUser(userId, userName) {
      console.log('üí¨ Opening chat with', userName)
      state.currentChatUser = { id: userId, name: userName }
      await loadMessagesWithUser(userId)
      state.screen = 'chat-conversation'
      render()
    }

    async function loadMessagesWithUser(userId) {
      try {
        console.log('üì• Loading messages with user:', userId)
        const data = await api(`/api/chat/messages/user/${userId}`)
        if (data.success) {
          state.messages = data.messages || []
          console.log('‚úÖ Loaded', state.messages.length, 'messages')
        } else {
          state.messages = []
        }
        render()
        setTimeout(() => {
          const div = document.getElementById('messages')
          if (div) div.scrollTop = div.scrollHeight
        }, 100)
      } catch (error) {
        console.error('‚ùå Error loading messages:', error)
        state.messages = []
        render()
      }
    }

    function sendMessage() {
      const input = document.getElementById('messageInput')
      if (!input) return
      
      const text = input.value.trim()
      if (!text) return
      
      console.log('üì§ Sending message:', text)

      api('/api/chat/send-direct', {
        method: 'POST',
        body: JSON.stringify({ 
          recipient_id: state.currentChatUser.id,
          text 
        })
      })
      .then(data => {
        if (data.success) {
          console.log('‚úÖ Message sent')
          input.value = ''
          loadMessagesWithUser(state.currentChatUser.id)
        } else {
          console.error('‚ùå Send failed:', data.error)
          alert('Failed to send: ' + (data.error || 'Unknown error'))
        }
      })
      .catch(error => {
        console.error('‚ùå Send error:', error)
        alert('Error: ' + error.message)
      })
    }
    
    // ============================================
    // NAVIGATION FUNCTIONS
    // ============================================
    
    function goTo(screen) {
      console.log('üß≠ Navigating to:', screen)
      state.screen = screen
      
      if (screen === 'home') loadUsers()
      else if (screen === 'explore') loadUsers()
      else if (screen === 'chat') loadAllUsers()
      
      render()
    }

    function logout() {
      console.log('üö™ Logging out...')
      localStorage.removeItem('elite_token')
      state = {
        screen: 'signin',
        user: null,
        profile: null,
        token: null,
        users: [],
        currentUserIndex: 0,
        allUsers: [],
        currentChatUser: null,
        messages: [],
        pendingAction: null,
        isWorldApp: state.isWorldApp
      }
      render()
    }
    
    // ============================================
    // RENDER
    // ============================================
    function renderBottomNav(active) {
      return `
        <div class="bottom-nav">
          <button class="nav-icon ${active === 'home' ? 'active' : ''}" onclick="goTo('home')">
            <span>üè†</span>
            <small>Home</small>
          </button>
          <button class="nav-icon ${active === 'explore' ? 'active' : ''}" onclick="goTo('explore')">
            <span>üî•</span>
            <small>Explore</small>
          </button>
          <button class="nav-icon ${active === 'chat' ? 'active' : ''}" onclick="goTo('chat')">
            <span>üí¨</span>
            <small>Chat</small>
          </button>
          <button class="nav-icon ${active === 'profile' ? 'active' : ''}" onclick="goTo('profile')">
            <span>üë§</span>
            <small>Profile</small>
          </button>
        </div>
      `
    }

    function render() {
      console.log('üé® Rendering screen:', state.screen)
      const app = document.getElementById('app')
      
      // CHECKING SCREEN
      if (state.screen === 'checking') {
        app.innerHTML = `
          <div class="container">
            <div class="card">
              <div class="content">
                <div class="logo">üåç</div>
                <h1>Elite Connect</h1>
                <p style="text-align: center; margin-top: 1rem;">Initializing...</p>
              </div>
            </div>
          </div>
        `
      }
      
      // NOT IN WORLD APP
      else if (!state.isWorldApp) {
        app.innerHTML = `
          <div class="container">
            <div class="card">
              <div class="content">
                <div class="logo">‚ö†Ô∏è</div>
                <h1>Open in World App</h1>
                <div class="error">
                  <strong>This app must be opened inside World App.</strong>
                  <br><br>
                  Please scan the QR code in World App or open via the Mini Apps section.
                </div>
                <div class="info">
                  <strong>For Developers:</strong><br>
                  Testing locally? Use ngrok or expose your local server, then update the App URL in World Developer Portal.
                </div>
                <button onclick="localStorage.clear(); location.reload()">
                  üóëÔ∏è Clear Cache & Reload
                </button>
              </div>
            </div>
          </div>
        `
      }
      
      // SIGN IN SCREEN
      else if (state.screen === 'signin') {
        app.innerHTML = `
          <div class="container">
            <div class="card">
              <div class="content">
                <div class="logo">üíï</div>
                <h1>Elite Connect</h1>
                <p style="text-align: center;">Verified connections for real people</p>
                
                <div style="background: #f0fdf4; padding: 1.5rem; border-radius: 12px; margin: 2rem 0;">
                  <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                    <span style="font-size: 2.5rem;">üåç</span>
                    <div>
                      <strong>World ID Required</strong><br>
                      <small>Orb-verified humans only</small>
                    </div>
                  </div>
                  <div style="display: flex; align-items: center; gap: 1rem;">
                    <span style="font-size: 2.5rem;">‚ú®</span>
                    <div>
                      <strong>No Bots, No Fakes</strong><br>
                      <small>100% authentic connections</small>
                    </div>
                  </div>
                </div>
                
                <button onclick="triggerWorldIDVerify()">
                  üåç Sign in with World ID
                </button>
                
                <p style="text-align: center; margin-top: 1rem; font-size: 0.85rem; opacity: 0.7;">
                  By continuing, you agree to our Terms of Service and Privacy Policy
                </p>
              </div>
            </div>
          </div>
        `
      }
      
      // PROFILE SETUP
      else if (state.screen === 'profile-setup') {
        app.innerHTML = `
          <div class="container">
            <div class="card">
              <div class="content">
                <div class="logo">‚ú®</div>
                <h1>Create Your Profile</h1>
                <p style="text-align: center; margin-bottom: 2rem;">Tell us about yourself</p>
                
                <form onsubmit="createProfile(event); return false;">
                  <label>Name *</label>
                  <input type="text" id="name" required placeholder="Your name">
                  
                  <label>Age *</label>
                  <input type="number" id="age" required min="18" max="100" placeholder="18">
                  
                  <label>Gender *</label>
                  <select id="gender" required>
                    <option value="">Select</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="other">Other</option>
                  </select>
                  
                  <label>Bio</label>
                  <textarea id="bio" rows="3" placeholder="Tell us about yourself..."></textarea>
                  
                  <label>Interests (comma-separated)</label>
                  <input type="text" id="interests" placeholder="hiking, music, travel">
                  
                  <button type="submit">‚úÖ Create Profile</button>
                </form>
              </div>
            </div>
          </div>
        `
      }
      
      // HOME & EXPLORE SCREENS
      else if (state.screen === 'home' || state.screen === 'explore') {
        const user = state.users[state.currentUserIndex]
        const title = state.screen === 'home' ? 'üè† Home' : 'üî• Explore'
        
        app.innerHTML = `
          <div class="container">
            <div class="card">
              <div class="content">
                <h2 style="text-align: center;">${title}</h2>
                ${!user ? `
                  <div class="empty">
                    <div class="logo">üîç</div>
                    <p>No more users</p>
                    <button onclick="loadUsers()">üîÑ Refresh</button>
                  </div>
                ` : `
                  <div class="user-card">
                    <div class="user-photo">${user.gender === 'male' ? 'üë®' : user.gender === 'female' ? 'üë©' : 'üßë'}</div>
                    <h2 style="margin: 0;">${user.name}, ${user.age}</h2>
                    <p style="color: #666; margin: 1rem 0;">${user.bio || 'No bio'}</p>
                    ${user.interests && user.interests.length > 0 ? 
                      user.interests.map(i => `<span class="badge">${i}</span>`).join('') : ''}
                    <div class="actions">
                      <button class="action-btn pass" onclick="swipe('pass')">‚úñÔ∏è</button>
                      <button class="action-btn like" onclick="swipeWithConfirmation('like')">üíö</button>
                      <button class="action-btn super" onclick="swipeWithConfirmation('super_like')">‚≠ê</button>
                    </div>
                  </div>
                `}
              </div>
              ${renderBottomNav(state.screen)}
            </div>
          </div>
        `
      }
      
      // CHAT LIST
      else if (state.screen === 'chat') {
        app.innerHTML = `
          <div class="container">
            <div class="card">
              <div class="content">
                <h2>üí¨ Chat with Users</h2>
                ${state.allUsers.length === 0 ? `
                  <div class="empty">
                    <div class="logo">üí¨</div>
                    <p>Loading users...</p>
                  </div>
                ` : state.allUsers.map(user => {
                  const emoji = user.gender === 'male' ? 'üë®' : user.gender === 'female' ? 'üë©' : 'üßë'
                  const likedBadge = user.isLiked ? 'üíö' : ''
                  return `
                    <div class="user-item" onclick="openChatWithUser('${user.id}', '${user.name}')">
                      <div class="user-avatar">${emoji}</div>
                      <div style="flex: 1;">
                        <strong style="font-size: 1.1rem;">${user.name}, ${user.age} ${likedBadge}</strong><br>
                        <small style="color: #666;">${user.bio || 'No bio'}</small>
                      </div>
                    </div>
                  `
                }).join('')}
              </div>
              ${renderBottomNav('chat')}
            </div>
          </div>
        `
      }
      
      // CHAT CONVERSATION
      else if (state.screen === 'chat-conversation') {
        app.innerHTML = `
          <div class="container">
            <div class="card">
              <div class="content">
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 2px solid #e0e0e0;">
                  <button class="btn-small btn-secondary" onclick="goTo('chat')">‚Üê Back</button>
                  <h2 style="margin: 0;">${state.currentChatUser?.name || 'Chat'}</h2>
                </div>
                <div class="chat-messages" id="messages">
                  ${state.messages.length === 0 ? 
                    '<p style="text-align: center; color: #999; padding: 2rem;">No messages yet. Say hi!</p>' :
                    state.messages.map(msg => `
                      <div class="message ${msg.is_mine ? 'own' : ''}">
                        ${msg.text}
                        <div class="message-time">${new Date(msg.created_at).toLocaleTimeString()}</div>
                      </div>
                    `).join('')
                  }
                </div>
                <div class="message-input">
                  <input type="text" id="messageInput" placeholder="Type a message..." 
                    onkeydown="if(event.key==='Enter') { event.preventDefault(); sendMessage(); }">
                  <button type="button" onclick="sendMessage()">Send</button>
                </div>
              </div>
              ${renderBottomNav('chat')}
            </div>
          </div>
        `
      }
      
      // PROFILE SCREEN
      else if (state.screen === 'profile' && state.profile) {
        app.innerHTML = `
          <div class="container">
            <div class="card">
              <div class="content">
                <div style="text-align: center; margin-bottom: 2rem;">
                  <div style="font-size: 6rem;">${state.profile.gender === 'male' ? 'üë®' : state.profile.gender === 'female' ? 'üë©' : 'üßë'}</div>
                  <h2>${state.profile.name}, ${state.profile.age}</h2>
                  <p style="color: #666; margin-top: 0.5rem;">${state.profile.bio || 'No bio'}</p>
                </div>
                
                ${state.profile.interests && state.profile.interests.length > 0 ? `
                  <div style="margin-bottom: 2rem;">
                    <strong>Interests:</strong><br>
                    ${state.profile.interests.map(i => `<span class="badge">${i}</span>`).join('')}
                  </div>
                ` : ''}
                
                <div class="success">
                  ‚úÖ Verified with World ID (Orb)
                </div>
                
                <button onclick="logout()" class="btn-cancel">
                  üö™ Logout
                </button>
              </div>
              ${renderBottomNav('profile')}
            </div>
          </div>
        `
      }
    }
    
    // ============================================
    // EXPOSE FUNCTIONS TO WINDOW
    // ============================================
    window.createProfile = createProfile
    window.swipe = swipe
    window.swipeWithConfirmation = swipeWithConfirmation
    window.cancelAction = cancelAction
    window.confirmAction = confirmAction
    window.goTo = goTo
    window.openChatWithUser = openChatWithUser
    window.sendMessage = sendMessage
    window.loadUsers = loadUsers
    window.logout = logout
    window.triggerWorldIDVerify = triggerWorldIDVerify
    
    // ============================================
    // INIT - SHOWS SIGNIN IMMEDIATELY
    // ============================================
    async function init() {
      console.log('üöÄ Init starting...')
      
      // Initialize MiniKit
      initMiniKit()
      
      console.log('üì± Is World App:', state.isWorldApp)
      
      // Check if in World App
      if (!state.isWorldApp) {
        console.log('‚ùå Not in World App - showing error')
        state.screen = 'not-world-app'
        render()
        return
      }
      
      console.log('‚úÖ In World App!')
      
      // ‚úÖ SHOW SIGN-IN SCREEN IMMEDIATELY (DON'T WAIT FOR BACKEND)
      state.screen = 'signin'
      render()
      
      console.log('‚úÖ Sign-in screen rendered')
      
      // Try to restore session in background (optional)
      if (state.token) {
        console.log('üîë Found token, attempting auto-login in background...')
        try {
          const data = await api('/api/profile/me')
          console.log('‚úÖ Token valid, auto-logging in')
          if (data.profile) {
            state.profile = data.profile
            state.screen = 'home'
            await loadUsers()
            render()
          }
        } catch (error) {
          console.log('‚ùå Token invalid or backend unavailable:', error.message)
          console.log('User can still sign in manually')
          // Stay on signin screen - user can click "Sign in with World ID"
        }
      } else {
        console.log('‚ÑπÔ∏è No token found - waiting for user to sign in')
      }
      
      console.log('‚úÖ Init complete!')
    }
    
    init()
    console.log('‚úÖ Elite Connect loaded!')
  </script>
</body>
</html>